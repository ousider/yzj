<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="xn.pigfarm.mapper.portal.PortalMapper">
	<!-- 存栏 -->
	<select id="searchListByDate" resultType="map">
			 <foreach collection="list" item="item" index="index" open="" close="" separator=" UNION ">
			<![CDATA[ 
			SELECT 	
				'${item.date}' AS DATE, 
				IF(COUNT(1)=0,0,SUM(IF(T0.PIG_TYPE = 1, 1, 0))) GZ_PIG,
				IF(COUNT(1)=0,0,SUM(IF(T0.PIG_TYPE = 2, 1, 0))) MZ_PIG,
				IF(COUNT(1)=0,0,SUM(IF(T0.PIG_TYPE = 3, 1, 0))) RZ_PIG,
				COUNT(1) ALL_PIG
			FROM pp_l_bill_towork T0
			LEFT JOIN pp_l_bill_leave T2
				ON T0.FARM_ID = T2.FARM_ID AND T0.PIG_ID = T2.PIG_ID AND T2.DELETED_FLAG = '0' AND T2.STATUS = '1'
			LEFT JOIN pp_l_pig T3
				ON T0.FARM_ID=T3.FARM_ID AND T0.DELETED_FLAG = T3.DELETED_FLAG AND T0.STATUS = T3.STATUS AND T0.PIG_ID = T3.ROW_ID 
			WHERE T0.FARM_ID = #{item.farmId} 
				AND T0.DELETED_FLAG = '0' 
				AND T0.STATUS = '1' 
				AND (T3.ORIGIN <> 3 OR T3.ORIGIN IS NULL) 
				AND T0.TOWORK_DATE <= '${item.date}'
				AND IFNULL(DATE(T0.TOWORK_DATE_OUT),IFNULL(DATE(T2.LEAVE_DATE),DATE(DATE_ADD(NOW(), INTERVAL 1 DAY)))) > '${item.date}'
			]]>
			</foreach>
	</select>
	
	
	<!-- 生产情况 -->
	<select id="searchProductionByDate" resultType="map">
			<foreach collection="list" item="item" index="index" open="" close="" separator=" UNION ">
		<![CDATA[ 
		SELECT 
		 	 '${item.startdate}' START_DATE,
		 	 '${item.enddate}' END_DATE,
			 '${item.index}' NUM_INDEX,
			 IF(COUNT(1)=0,0,SUM(IF(T.PIG_CLASS IN (1,3),1,0))) MRHB_PIG,
			 IF(COUNT(1)=0,0,SUM(IF(T.PIG_CLASS IN (4),1,0))) ZRDP_PIG,
			 IF(COUNT(1)=0,0,SUM(IF(T.PIG_CLASS IN (9),1,0))) PZ_PIG,
			 IF(COUNT(1)=0,0,SUM(IF(T.PIG_CLASS IN (10),1,0))) FM_PIG,
			 IF(COUNT(1)=0,0,SUM(IF(T.PIG_CLASS IN (12,13),1,0))) FMZZ_PIG,
			 IF(COUNT(1)=0,0,SUM(IF(T.PIG_CLASS IN (11),1,0))) DN_SOW_PIG,
			 IF(COUNT(1)=0,0,SUM(IF(T.PIG_CLASS IN (14),1,0))) DN_PIG,
			 IF(COUNT(1)=0,0,SUM(IF(T.PIG_CLASS IN (15),1,0))) ZBY_PIG,
			 IF(COUNT(1)=0,0,SUM(IF(T.PIG_CLASS IN (16),1,0))) ZYF_PIG,
			 IF(COUNT(1)=0,0,SUM(IF(T.PIG_CLASS IN (25) AND T.SALE_TYPE = 1 AND T.SALE_DESCRIBE = 4,1,0))) MZ_SALE_PIG,
			 IF(COUNT(1)=0,0,SUM(IF(T.PIG_CLASS IN (25) AND T.SALE_TYPE = 1 AND T.SALE_DESCRIBE = 3,1,0))) FZ_SALE_PIG,
			 IF(COUNT(1)=0,0,SUM(IF(T.PIG_CLASS IN (25) AND T.SALE_TYPE = 1 AND T.SALE_DESCRIBE = 5,1,0))) CC_SALE_PIG,
			 IF(COUNT(1)=0,0,SUM(IF(T.PIG_CLASS IN (25) AND T.SALE_TYPE = 2,1,0))) ZZ_SALE_PIG,
			 IF(COUNT(1)=0,0,SUM(IF(T.PIG_CLASS IN (25) AND T.SALE_TYPE = 3,1,0))) ZZ_OUT_PIG,
			 IF(COUNT(1)=0,0,SUM(IF(T.PIG_CLASS IN (25) AND T.SALE_TYPE = 4,1,0))) FARM_KILL_PIG
		 FROM (
			 SELECT P1.PIG_CLASS,B.SALE_TYPE,C.SALE_DESCRIBE
			 FROM PP_L_BILL_TOWORK P1
			 LEFT JOIN PP_L_BILL_PIG_SALE B 
			 ON P1.DELETED_FLAG = B.DELETED_FLAG AND P1.STATUS = B.STATUS AND P1.BILL_ID = B.BILL_ID AND P1.FARM_ID = B.FARM_ID
			 LEFT JOIN PP_L_BILL_PIG_SALE_DETAIL C 
			 ON B.DELETED_FLAG = C.DELETED_FLAG AND B.STATUS = C.STATUS AND B.BILL_ID = C.BILL_ID AND B.FARM_ID = C.FARM_ID
			 WHERE  P1.STATUS=1
			 AND P1.DELETED_FLAG=0
			 AND p1.FARM_ID = '${item.farmId}'
			 AND p1.TOWORK_DATE >= '${item.startdate}'
			 AND p1.TOWORK_DATE <= '${item.enddate}'
		GROUP BY P1.PIG_ID,P1.PIG_CLASS
			) T
		]]>
		</foreach>
	</select>
	<!-- 死亡分析 -->
	<select id="searchDieByDate" resultType="map">
		<foreach collection="list" item="item" index="index" open="" close="" separator=" UNION ">
			<![CDATA[ 
				SELECT  
					#{item.enddate} END_DATE,
					IF(COUNT(1)=0,0,SUM(IF(t.PIG_CLASS IN (1,2,3,4,5,6,7,8,9,10,11,17,18),1,0))) ZZ_PIG, 
					IF(COUNT(1)=0,0,SUM(IF(t.PIG_CLASS IN (IF(_getSettingValueByCode(13,'RZBSCL') = 'ON',12,13),12,14),1,0))) CFZZ_PIG,
					IF(COUNT(1)=0,0,SUM(IF(t.PIG_CLASS IN (15),1,0))) BY_PIG,
					IF(COUNT(1)=0,0,SUM(IF(t.PIG_CLASS IN (16),1,0))) YF_PIG
				FROM pp_l_bill_leave t
				WHERE t.DELETED_FLAG = 0 AND t.STATUS= 1
				AND t.LEAVE_TYPE NOT IN ('1','5')
				AND T.FARM_ID= ${item.farmId}
				AND T.LEAVE_DATE> #{item.startdate}
				AND T.LEAVE_DATE<= #{item.enddate}
			]]>
		</foreach>
	</select>
	
	<!-- 废弃 - 胎次分布 -->
	<select id="searchParity" resultType="map">
		<foreach collection="list" item="item" index="index" open="" close="" separator=" UNION ALL ">
			<![CDATA[ 
				SELECT   M.PARITY PARITY,
					  M.NOW_NUM NOW_NUM,
					  M.NOW_NUM / M.REAL_NUM * 100 NOW_PERCENT,
					  M.OLD_NUM,
					  M.OLD_NUM / M.OLD_ALL_NUM * 100 OLD_PERCENT,
					  CEIL(M.PERCENT * NOW_ALL_NUM / 100) T_NUM,
					  M.PERCENT T_PERCENT 
					FROM (
						SELECT S.PARITY,S.NOW_NUM,P.ALL_NUM NOW_ALL_NUM,T.OLD_NUM,T.ALL_NUM OLD_ALL_NUM,N.PERCENT,R.REAL_NUM FROM 
						(
						SELECT ${item.parity} PARITY, IFNULL(SUM(IF(A.PARITY = ${item.parity} ,1,0)),0) NOW_NUM, IFNULL(SUM(IF(A.PARITY BETWEEN 1 AND 11,1,0)),0) ALL_NUM FROM PP_L_PIG A WHERE A.DELETED_FLAG = '0' AND A.FARM_ID = ${item.farmId} AND A.PIG_TYPE = 2 AND A.LEAVE_DATE IS NULL AND PIG_CLASS NOT IN(3,4) AND A.PARITY > 0 
						) S,
						(
						SELECT IF(COUNT(1)=0,0,SUM(IF(a.PARITY= ${item.parity},1,0))) OLD_NUM,IF(COUNT(1)=0,0,SUM(IF(a.PARITY BETWEEN 1 AND 11,1,0))) ALL_NUM FROM pp_l_bill_parity a WHERE a.DELETED_FLAG=0 AND a.STATUS=1 AND a.FARM_ID= ${item.farmId} AND A.PARITY_DATE <= '${item.oldenddate}' 
						) T,
						(SELECT C.PERCENT FROM pt_o_parity_distribution C WHERE C.STATUS = 1 AND C.deleted_flag = 0 AND C.PARITY= ${item.parity}) N,
						(
							SELECT IFNULL(
											${item.pigNum},
											(
												SELECT A.STANDARD_VALUE ALL_NUM FROM pp_l_indicator a WHERE a.DELETED_FLAG = 0 AND a.STATUS=1 AND a.BUSINESS_CODE='Z001' AND a.FARM_ID= ${item.farmId2}
											) 
										) All_NUM 
						) P,
						(SELECT IF(COUNT(1)=0,1,COUNT(1)) REAL_NUM FROM PP_L_PIG WHERE DELETED_FLAG = 0 AND PIG_TYPE = '2' AND FARM_ID = ${item.farmId} AND PIG_CLASS NOT IN(3,4) AND PIG_CLASS < 18) R
					) M
			]]>
		</foreach>
	</select>
	
	<!-- 胎次分布 -->
	<select id="searchParityGroup" resultType="map">
			<![CDATA[ 
			SELECT T1.PARITY,T1.NOW_NUM,T1.NOW_PERCENT,T2.OLD_NUM,T2.OLD_PERCENT,T3.T_NUM,T3.T_PERCENT
			FROM (
			SELECT 
				IF(A.PARITY>10,11,A.PARITY) PARITY,
				COUNT(1) NOW_NUM,
				COUNT(1)*100 /
				(
					SELECT COUNT(1) NOW_ALL_NUM
					FROM PP_L_PIG A 
					WHERE A.DELETED_FLAG = 0 
					AND A.STATUS = 1 
					AND A.FARM_ID IN ( ${farmIds} )
					AND A.PIG_TYPE = 2 
					AND A.PARITY > 0 
					AND A.LEAVE_DATE IS NULL 		
				) NOW_PERCENT
			
			FROM PP_L_PIG A 
			WHERE A.DELETED_FLAG = 0 
			AND A.STATUS = 1 
			AND A.FARM_ID IN ( ${farmIds} )
			AND A.PIG_TYPE = 2 
			AND A.PARITY > 0 
			AND A.LEAVE_DATE IS NULL 
			GROUP BY IF(A.PARITY>10,11,A.PARITY)
			) T1 
			LEFT JOIN 
			(
			SELECT 
				IF(A.PARITY>10,11,A.PARITY) PARITY,
				COUNT(1) OLD_NUM,
				COUNT(1)*100 / 
				(
					SELECT COUNT(1) OLD_ALL_NUM 
					FROM
					  PP_L_BILL_TOWORK A 
					  INNER JOIN PP_L_PIG B 
					  ON A.FARM_ID = B.FARM_ID AND A.PIG_ID = B.ROW_ID AND B.DELETED_FLAG = '0' 
					WHERE A.DELETED_FLAG = '0' 
					  AND A.PIG_TYPE = 2 
					  AND A.PARITY > 0 
					  AND A.FARM_ID IN ( ${farmIds} )
					  AND A.TOWORK_DATE <= DATE_ADD(CURRENT_DATE(), INTERVAL - 1 YEAR) 
					  AND IFNULL(A.TOWORK_DATE_OUT,IFNULL(B.LEAVE_DATE,DATE_ADD(NOW(),INTERVAL 1 DAY))) > DATE_ADD(CURRENT_DATE(), INTERVAL - 1 YEAR) 
				) OLD_PERCENT
			FROM
			  PP_L_BILL_TOWORK A 
			  INNER JOIN PP_L_PIG B 
			  ON A.FARM_ID = B.FARM_ID AND A.PIG_ID = B.ROW_ID AND B.DELETED_FLAG = '0' 
			WHERE A.DELETED_FLAG = '0' 
			  AND A.PIG_TYPE = 2 
			  AND A.PARITY > 0 
			  AND A.FARM_ID IN ( ${farmIds} )
			  AND A.TOWORK_DATE <= DATE_ADD(CURRENT_DATE(), INTERVAL - 1 YEAR) 
			  AND IFNULL(A.TOWORK_DATE_OUT,IFNULL(B.LEAVE_DATE,DATE_ADD(NOW(),INTERVAL 1 DAY))) > DATE_ADD(CURRENT_DATE(), INTERVAL - 1 YEAR)  
			GROUP BY IF(A.PARITY>10,11,A.PARITY)
			) T2 
			ON T1.PARITY = T2.PARITY 
			LEFT JOIN 
			(
			SELECT 
				A.PARITY,
				A.PERCENT T_PERCENT,
				CEIL(A.PERCENT / 100 * 
				 (
					SELECT IFNULL(
						${pigNum},
						(
							SELECT A.STANDARD_VALUE ALL_NUM 
							FROM PP_L_INDICATOR A 
							WHERE A.DELETED_FLAG = '0' AND A.STATUS= '1' 
							AND A.BUSINESS_CODE='Z001' AND A.FARM_ID= ${farmId2}
						) 
					) 
				)) T_NUM
			 FROM PT_O_PARITY_DISTRIBUTION A WHERE A.DELETED_FLAG = 0 AND A.STATUS = 1 AND A.PARITY > 0 
			) T3
			ON T1.PARITY = T3.PARITY 
			
			]]>
	</select>
	
	<select id="searchSwineryByFarmId" resultType="map">
		<![CDATA[ 
			SELECT A.ROW_ID FROM PP_M_SWINERY A 
			WHERE A.PIG_TYPE=2 AND A.FARM_ID= #{farmId}
			AND A.BEGIN_DATE >= #{startdate} ORDER BY A.WEEK_NUM;
		]]>
	</select>
	
	<select id="searchSwineryClassNumByDate" resultType="map">
		<foreach collection="list" item="item" index="index" open="" close="" separator=" UNION ">
			<![CDATA[ 
			
			SELECT T.SWINERY_ID ,T.SWINERY_NAME ,T.WEEK_INDEX ,T.WEEK_YEAR ,COUNT(1) PIG_NUM,T.TOWORK_DATE ,T.PIG_CLASS ,T.PIG_CLASS_NAME 
			FROM (
				SELECT A.SWINERY_ID SWINERY_ID,C.SWINERY_NAME SWINERY_NAME,21-${item.weekindex} WEEK_INDEX,B.WEEK WEEK_YEAR,A.TOWORK_DATE TOWORK_DATE, 
					A.PIG_CLASS PIG_CLASS,IF(A.PIG_CLASS IN (6,7,8,9),'怀孕',IF(A.PIG_CLASS IN (10),'分娩',IF(A.PIG_CLASS IN (11),'断奶','其他'))) PIG_CLASS_NAME 
				FROM PP_L_BILL_TOWORK A 
				LEFT JOIN CD_O_WEEK B 
				ON A.FARM_ID=B.FARM_ID LEFT JOIN PP_M_SWINERY C ON A.FARM_ID=C.FARM_ID AND A.DELETED_FLAG=C.DELETED_FLAG AND A.STATUS=C.STATUS AND A.SWINERY_ID=C.ROW_ID  AND B.DELETED_FLAG = 0 AND B.STATUS = 1  
				WHERE A.DELETED_FLAG = 0 AND A.STATUS = 1 AND a.TOWORK_DATE >= b.START_DATE AND a.TOWORK_DATE <= b.END_DATE 
					AND a.SWINERY_ID IS NOT NULL
					AND a.pig_class BETWEEN 6 AND 11
					AND a.FARM_ID = ${item.farmId} 
				 AND a.TOWORK_DATE >= (
						SELECT w.START_DATE START_DATE
						FROM cd_o_week w 
						WHERE 
						 w.START_DATE <= DATE_ADD(NOW(),INTERVAL -${item.weekindex} WEEK) AND w.FARM_ID = ${item.farmId} 
						  AND W.DELETED_FLAG = 0 AND W.STATUS = 1  
						 AND w.END_DATE >= DATE_ADD(DATE_ADD(NOW(),INTERVAL -${item.weekindex} WEEK),INTERVAL -1 DAY)
					)
				 AND a.TOWORK_DATE <= (
						SELECT w.END_DATE END_DATE
						FROM cd_o_week w 
						WHERE 
						 w.START_DATE <= DATE_ADD(NOW(),INTERVAL -${item.weekindex} WEEK) AND w.FARM_ID = ${item.farmId}
						  AND W.DELETED_FLAG = 0 AND W.STATUS = 1  
						 AND w.END_DATE >= DATE_ADD(DATE_ADD(NOW(),INTERVAL -${item.weekindex} WEEK),INTERVAL -1 DAY)
					)
				GROUP BY a.PIG_ID
			) T GROUP BY t.SWINERY_ID,t.PIG_CLASS_NAME 
			]]>
		</foreach>
	</select>
	
	<select id="searchSwineryClassNumBySwineryId" resultType="map">
		<![CDATA[ 
		SELECT C.SWINERY_NAME SWINERY_NAME,COUNT(1) PIG_NUM,B.WEEK WEEK,B.YEAR,A.TOWORK_DATE TOWORK_DATE, A.PIG_CLASS PIG_CLASS,IF(A.PIG_CLASS IN (6,7,8,9),'HY',IF(A.PIG_CLASS IN (10),'FM',IF(A.PIG_CLASS IN (11),'DN','OTHER'))) PIG_CLASS_NAME 
		FROM PP_L_BILL_TOWORK A 
		LEFT JOIN CD_O_WEEK B ON A.FARM_ID=B.FARM_ID  AND B.DELETED_FLAG = 0 AND B.STATUS = 1  
		LEFT JOIN PP_M_SWINERY C ON A.FARM_ID=C.FARM_ID AND A.DELETED_FLAG=C.DELETED_FLAG AND A.STATUS=C.STATUS AND A.SWINERY_ID=C.ROW_ID
		WHERE A.DELETED_FLAG = 0 AND A.STATUS = 1 AND A.TOWORK_DATE > B.START_DATE AND A.TOWORK_DATE <= B.END_DATE AND A.SWINERY_ID IS NOT NULL AND A.PIG_CLASS BETWEEN 6 AND 11 
		AND A.FARM_ID = ${farmId}
		AND A.SWINERY_ID IN (${swineryId})
		GROUP BY B.WEEK,A.SWINERY_ID,A.PIG_CLASS
		]]>
	</select>
	
	<select id="searchSwineryIdLimit4" resultType="map">
			<![CDATA[ 
			SELECT A.SWINERY_ID FROM PP_L_BILL_TOWORK A 
				WHERE A.DELETED_FLAG=0 AND A.STATUS=1 
				AND A.FARM_ID= #{farmId}
				AND A.TOWORK_DATE>=(
					SELECT W.START_DATE START_DATE
					FROM CD_O_WEEK W 
					WHERE  W.FARM_ID = #{farmId}
					AND W.START_DATE <= DATE_ADD(NOW(),INTERVAL -20 WEEK) 
					 AND W.DELETED_FLAG = 0 AND W.STATUS = 1  
					AND W.END_DATE >= DATE_ADD(DATE_ADD(NOW(),INTERVAL -20 WEEK),INTERVAL -1 DAY)
				)
				AND A.PIG_TYPE = 2
				AND A.PIG_CLASS BETWEEN 6 AND 11
				AND A.SWINERY_ID IS NOT NULL 
				GROUP BY A.SWINERY_ID LIMIT 4
			]]>
	</select>
	
	<select id="searchWeekInYear" resultType="map">
		<![CDATA[
			SELECT CO.WEEK,CO.START_DATE,CO.END_DATE,CO.YEAR
			FROM CD_O_WEEK CO 
			WHERE CO.START_DATE > DATE_ADD(NOW(),INTERVAL -#{weekHeight} WEEK) AND CO.FARM_ID= #{farmId} 
			AND DELETED_FLAG = 0 AND STATUS = 1 
			ORDER BY CO.START_DATE LIMIT #{weekHeight}
		]]>
	</select>
	
	<select id="searchPigExceptionScale" resultType="map">
			<![CDATA[ 
			
			SELECT a.SWINERY_ID,TRUNCATE(IF(A.PREGNANCY_RESULT = 4 ,1,0)/${pigallnum}*100,2) FQ, TRUNCATE(IF(A.PREGNANCY_RESULT = 5 ,1,0)/${pigallnum}*100,2) LC, TRUNCATE(IF(A.PREGNANCY_RESULT = 6 ,1,0)/${pigallnum}*100,2) KH
				FROM PP_L_BILL_PREGNANCY_CHECK A 
				LEFT JOIN CD_O_WEEK W 
				ON A.PREGNANCY_DATE>= W.START_DATE AND A.PREGNANCY_DATE < W.END_DATE+1 AND a.FARM_ID = w.FARM_ID AND W.DELETED_FLAG = 0 AND W.STATUS = 1  
				WHERE A.DELETED_FLAG=0 AND A.STATUS=1 
				AND A.PREGNANCY_RESULT IN (4,5,6) 
				AND A.FARM_ID= ${farmId} 
				AND A.SWINERY_ID IN (${swineryid})
				AND A.PREGNANCY_DATE >= ( 
					SELECT w.START_DATE START_DATE 
					FROM cd_o_week w WHERE w.START_DATE <= DATE_ADD(NOW(),INTERVAL -20 WEEK) 
					 AND W.DELETED_FLAG = 0 AND W.STATUS = 1  
					AND w.FARM_ID = ${farmId} 
					AND w.END_DATE >= DATE_ADD(DATE_ADD(NOW(),INTERVAL -20 WEEK),INTERVAL -1 DAY) 
				) 
				ORDER BY A.PREGNANCY_RESULT, A.CREATE_DATE DESC 
				
			]]>
	</select>
	
	<select id="searchSwineryPigExcepitionBySwineryId" resultType="map">
			<![CDATA[ 
			pp_l_bill_pregnancy_check
			]]>
	</select>
	<select id="searchWeek" resultType="map">
			<![CDATA[ 
			SELECT 
			  w.WEEK week,
			  w.START_DATE startDate,
			  w.END_DATE endDate
			FROM
			  cd_o_week w 
			WHERE w.FARM_ID = ${farmId} 
			  AND w.DELETED_FLAG = 0 AND w.STATUS = 1 
			  AND w.START_DATE <= NOW() 
			ORDER BY w.START_DATE DESC 
			LIMIT 21 
			]]>
	</select>
	
	<!-- 母猪群蓝图 -->
	<select id="searchSwineryClass" resultType="map">
			<![CDATA[ 
			SELECT 
				p.ROW_ID SWINERY_ID,
				p.SWINERY_NAME SWINERY_NAME,
				p2.PIG_CLASS PIG_CLASS,
				DATE(p2.TOWORK_DATE) TOWORK_DATE,
				SUM(1) PIG_NUM						
			FROM pp_m_swinery p 
			LEFT JOIN pp_l_pig p1 ON p1.SWINERY_ID = p.ROW_ID AND p.FARM_ID = p1.FARM_ID
			AND p1.DELETED_FLAG = 0 AND p1.STATUS = 1 AND p1.PIG_TYPE = 2 AND p1.PIG_CLASS IN(3,4,5,6,7,8,9,10,11)
			LEFT JOIN pp_l_bill_towork p2 ON p2.PIG_ID = p1.ROW_ID AND p2.STATUS =  1 AND p2.DELETED_FLAG = 0 
			AND (p2.SWINERY_ID = p1.SWINERY_ID OR p2.PARITY = p1.PARITY) 
			AND p2.FARM_ID = p.FARM_ID
			WHERE 
			p.FARM_ID =${farmId}
			AND p.CREATE_TYPE = 1
			AND p.DELETED_FLAG = 0
			AND p.STATUS = 1
			AND p2.PIG_CLASS IS NOT NULL
			AND p.SWINERY_NAME IS NOT NULL
			AND DATE(p2.TOWORK_DATE) >= p.BEGIN_DATE
			GROUP BY p.ROW_ID,p2.PIG_CLASS,DATE(p2.TOWORK_DATE)
			ORDER BY p.BEGIN_DATE,DATE(p2.TOWORK_DATE)
			]]>
	</select>
	<select id="productionAbnormalByBreed" resultType="map">
			<![CDATA[ 
				SELECT 1 SORT_NBR,CONCAT('7天未采精公猪') MESSAGE,COUNT(*) PIG_QTY 
				FROM pp_l_pig T0
				LEFT JOIN (
					SELECT T.PIG_ID,T.FARM_ID,MAX(DATE(SEMEN_DATE)) SEMEN_DATE FROM pp_l_bill_semen T WHERE T.STATUS = '1' AND T.DELETED_FLAG = '0'
					GROUP BY T.PIG_ID
				) T1
				ON T0.FARM_ID = T1.FARM_ID AND T0.ROW_ID = T1.PIG_ID 
				WHERE T0.FARM_ID = ${farmId} AND T0.STATUS = '1' AND T0.DELETED_FLAG = '0' AND T0.PIG_TYPE = 1 AND T0.PIG_CLASS = 2 AND DATEDIFF(DATE(NOW()),IFNULL(T1.SEMEN_DATE,DATE_SUB(DATE(NOW()),INTERVAL 9 DAY))) > 7
				AND T0.ORIGIN <> 3
				UNION ALL 
				SELECT 2 SORT_NBR,CONCAT('7胎及以上母猪') MESSAGE,COUNT(*) PIG_QTY 
				FROM pp_v_pig T0
				WHERE T0.FARM_ID = ${farmId} AND T0.STATUS = '1' AND T0.DELETED_FLAG = '0' AND T0.PIG_TYPE = 2 
				AND T0.PARITY >= 7 AND T0.PIG_CLASS < 19
				UNION ALL 
				SELECT 3 SORT_NBR,CONCAT('返情待配') MESSAGE,COUNT(*) PIG_QTY 
				FROM pp_v_pig T0
				WHERE T0.FARM_ID = ${farmId} AND T0.STATUS = '1' AND T0.DELETED_FLAG = '0' AND T0.PIG_TYPE = 2 
				AND T0.PIG_CLASS = 6
				UNION ALL 
				SELECT 4 SORT_NBR,CONCAT('流产待配') MESSAGE,COUNT(*) PIG_QTY 
				FROM pp_v_pig T0
				WHERE T0.FARM_ID = ${farmId} AND T0.STATUS = '1' AND T0.DELETED_FLAG = '0' AND T0.PIG_TYPE = 2 
				AND T0.PIG_CLASS = 7
				UNION ALL 
				SELECT 5 SORT_NBR,CONCAT('空怀待配') MESSAGE,COUNT(*) PIG_QTY 
				FROM pp_v_pig T0
				WHERE T0.FARM_ID = ${farmId} AND T0.STATUS = '1' AND T0.DELETED_FLAG = '0' AND T0.PIG_TYPE = 2 
				AND T0.PIG_CLASS = 8
				UNION ALL 
				SELECT 6 SORT_NBR,CONCAT('后备母猪>270日龄') MESSAGE,COUNT(*) PIG_QTY 
				FROM pp_v_pig T0
				WHERE T0.FARM_ID = ${farmId} AND T0.STATUS = '1' AND T0.DELETED_FLAG = '0' AND T0.PIG_TYPE = 2 
				AND T0.PIG_CLASS BETWEEN 3 AND 4 AND T0.DATEAGE > 270
				UNION ALL 
				SELECT 7 SORT_NBR,CONCAT('7-10天断奶待配母猪') MESSAGE,COUNT(*) PIG_QTY 
				FROM pp_v_pig T0
				LEFT JOIN (
					SELECT T.FARM_ID,T.PIG_ID,T.WEAN_DATE,T.PARITY FROM pp_l_bill_wean T
					WHERE T.DELETED_FLAG = '0' AND T.STATUS = '1'
				) T1
				ON T0.FARM_ID = T1.FARM_ID AND T0.PIG_ID = T1.PIG_ID AND T0.PARITY = T1.PARITY
				WHERE T0.FARM_ID = ${farmId} AND T0.STATUS = '1' AND T0.DELETED_FLAG = '0' AND T0.PIG_TYPE = 2 
				AND T0.PIG_CLASS = 11 AND DATEDIFF(DATE(NOW()),IFNULL(T1.WEAN_DATE,ENTER_DATE)) BETWEEN 7 AND 10
				UNION ALL 
				SELECT 8 SORT_NBR,CONCAT('11-21天断奶待配母猪') MESSAGE,COUNT(*) PIG_QTY 
				FROM pp_v_pig T0
				LEFT JOIN (
					SELECT T.FARM_ID,T.PIG_ID,T.WEAN_DATE,T.PARITY FROM pp_l_bill_wean T
					WHERE T.DELETED_FLAG = '0' AND T.STATUS = '1'
				) T1
				ON T0.FARM_ID = T1.FARM_ID AND T0.PIG_ID = T1.PIG_ID AND T0.PARITY = T1.PARITY
				WHERE T0.FARM_ID = ${farmId} AND T0.STATUS = '1' AND T0.DELETED_FLAG = '0' AND T0.PIG_TYPE = 2 
				AND T0.PIG_CLASS = 11 AND DATEDIFF(DATE(NOW()),IFNULL(T1.WEAN_DATE,ENTER_DATE)) BETWEEN 11 AND 21
				UNION ALL
				SELECT 9 SORT_NBR,CONCAT('21天以上断奶待配母猪') MESSAGE,COUNT(*) PIG_QTY 
				FROM pp_v_pig T0
				LEFT JOIN (
					SELECT T.FARM_ID,T.PIG_ID,T.WEAN_DATE,T.PARITY FROM pp_l_bill_wean T
					WHERE T.DELETED_FLAG = '0' AND T.STATUS = '1'
				) T1
				ON T0.FARM_ID = T1.FARM_ID AND T0.PIG_ID = T1.PIG_ID AND T0.PARITY = T1.PARITY
				WHERE T0.FARM_ID = ${farmId} AND T0.STATUS = '1' AND T0.DELETED_FLAG = '0' AND T0.PIG_TYPE = 2 
				AND T0.PIG_CLASS = 11 AND DATEDIFF(DATE(NOW()),IFNULL(T1.WEAN_DATE,ENTER_DATE)) > 21
			]]>
	</select>
	
	<select id="productionAbnormalByLaborHouse" resultType="map">
			<![CDATA[ 
				 SELECT 1 SORT_NBR,CONCAT('妊娠107-109天待上产房母猪') MESSAGE,COUNT(*)PIG_QTY
				 FROM pp_l_pig T0
				 LEFT JOIN (
						SELECT T1.FARM_ID,T1.PIG_ID,T1.DELETED_FLAG,T1.STATUS,MAX(T1.BREED_DATE_FIRST) BREED_DATE_FIRST,MAX(T1.PARITY) PARITY FROM PP_L_BILL_BREED T1 
						WHERE T1.DELETED_FLAG =0 AND T1.FARM_ID = 248  AND T1.DELETED_FLAG = '0' AND T1.STATUS = '1'
						GROUP BY T1.PIG_ID
					) T1
				 ON T0.FARM_ID = T1.FARM_ID AND T0.ROW_ID = T1.PIG_ID AND t0.DELETED_FLAG = T1.DELETED_FLAG  AND t1.STATUS = T1.STATUS AND T0.PARITY = T1.PARITY
				 INNER JOIN pp_o_house T3
				 ON T0.HOUSE_ID = T3.ROW_ID AND T3.HOUSE_TYPE <> 6 AND T3.DELETED_FLAG = '0'
				 WHERE t0.DELETED_FLAG = 0 AND t0.STATUS = 1 AND T0.FARM_ID = ${farmId} AND T0.PIG_CLASS  = 9 AND DATEDIFF(DATE(NOW()),T1.BREED_DATE_FIRST) BETWEEN 107 AND 109
				 UNION ALL 
					 SELECT 2 SORT_NBR,CONCAT('妊娠大于110天待上产房母猪') MESSAGE,COUNT(*) PIG_QTY
					 FROM pp_l_pig T0
					--  LEFT JOIN pp_l_bill_breed T1
					--  ON T0.FARM_ID = T1.FARM_ID AND T0.ROW_ID = T1.PIG_ID AND T1.DELETED_FLAG = '0' AND T1.STATUS = '1' AND T0.PARITY = T1.PARITY
					 INNER JOIN pp_o_house T2
					 ON T0.FARM_ID = T2.FARM_ID AND T0.HOUSE_ID = T2.ROW_ID AND T2.HOUSE_TYPE <> 6 AND T2.DELETED_FLAG = '0'
					 WHERE T0.FARM_ID = ${farmId} AND t0.DELETED_FLAG = 0 AND t0.STATUS = 1 AND T0.PIG_CLASS  = 9 AND DATEDIFF(DATE(NOW()),T0.LAST_CLASS_DATE) >= 110
				 UNION ALL
				 SELECT 3 SORT_NBR,CONCAT('可上产房栋舍') MESSAGE,COUNT(*) PIG_QTY FROM(
				 SELECT T0.row_id,COUNT(T1.ROW_ID) PIG_QTY 
				 FROM pp_o_house T0
				 LEFT JOIN pp_l_pig T1
				 ON T0.FARM_ID = T1.FARM_ID AND T0.ROW_ID = T1.HOUSE_ID AND T1.DELETED_FLAG = '0' AND T1.STATUS = '1'
				 LEFT JOIN (
						 SELECT T.FARM_ID,T.HOUSE_ID,MAX(DATE(T.CHANGE_HOUSE_DATE)) CHANGE_HOUSE_DATE FROM pp_l_bill_change_house T
						 WHERE T.DELETED_FLAG = '0' AND T.STATUS = '1'  AND T.FARM_ID = ${farmId}
						 GROUP BY T.HOUSE_ID
					 ) T2
					 ON T0.FARM_ID = T2.FARM_ID AND T0.ROW_ID = T2.HOUSE_ID
					 WHERE T0.FARM_ID = ${farmId} AND T0.DELETED_FLAG = '0' AND T0.STATUS = '1' AND T0.HOUSE_TYPE = 6 
					 AND DATEDIFF(DATE(NOW()),IFNULL(T2.CHANGE_HOUSE_DATE,DATE_SUB(DATE(NOW()),INTERVAL 10 DAY))) >= 7
					 GROUP BY T0.ROW_ID
					 HAVING PIG_QTY <= 0
				 ) T
			]]>
	</select>
	
	<select id="productionAbnormalByDelivery" resultType="map">
			<![CDATA[ 
				SELECT 1 SORT_NBR,CONCAT('产房待分娩母猪') MESSAGE,COUNT(*) PIG_QTY
				 FROM pp_v_pig T0
				 INNER JOIN pp_o_house T1
				 ON T0.FARM_ID = T1.FARM_ID AND T0.HOUSE_ID = T1.ROW_ID AND T1.HOUSE_TYPE = 6 AND T1.DELETED_FLAG = '0' AND T1.STATUS = '1'
				 WHERE T0.FARM_ID = ${farmId} AND T0.DELETED_FLAG = '0' AND T0.STATUS = '1' AND T0.PIG_TYPE = 2 AND T0.PIG_CLASS = 9
				 
				 UNION ALL
				 
				 SELECT 2 SORT_NBR,CONCAT('妊娠大于或等于120天未产母猪') MESSAGE,COUNT(*) PIG_QTY
				 FROM pp_v_pig T0
				 INNER JOIN (
					SELECT T.PIG_ID,T.FARM_ID,T.PARITY,MAX(T.BREED_DATE_FIRST) BREED_DATE_FIRST  FROM pp_l_bill_breed T WHERE T.DELETED_FLAG = '0' AND T.STATUS = '1' -- AND T.PIG_ID = 165453
					GROUP BY T.PIG_ID,T.PARITY
				 ) T1
				 ON T0.FARM_ID = T1.FARM_ID AND T0.PIG_ID = T1.PIG_ID AND T0.PARITY = T1.PARITY 
				 WHERE T0.FARM_ID = ${farmId} AND T0.DELETED_FLAG = '0' AND T0.STATUS = '1' AND T0.PIG_TYPE = 2 AND T0.PIG_CLASS = 9 AND DATEDIFF(DATE(NOW()),T1.BREED_DATE_FIRST) >= 120
				 
				 UNION ALL
				 
				 SELECT 3 SORT_NBR,CONCAT('产房初产母猪（一胎母猪）') MESSAGE,COUNT(*) PIG_QTY
				 FROM pp_v_pig T0
				 INNER JOIN pp_o_house T1
				 ON T0.FARM_ID = T1.FARM_ID AND T0.HOUSE_ID = T1.ROW_ID AND T1.HOUSE_TYPE = 6 AND T1.DELETED_FLAG = '0' AND T1.STATUS = '1'
				 WHERE T0.FARM_ID = ${farmId} AND T0.DELETED_FLAG = '0' AND T0.STATUS = '1' AND T0.PIG_TYPE = 2 AND T0.PIG_CLASS = 9 AND T0.PARITY = 1
				 
				 UNION ALL
				 SELECT 4 SORT_NBR,CONCAT('在产房8胎及以上母猪') MESSAGE,COUNT(*) PIG_QTY
				 FROM pp_v_pig T0
				 INNER JOIN PP_O_HOUSE T1
				 ON T0.FARM_ID = T1.FARM_ID AND T0.HOUSE_ID = T1.ROW_ID AND T1.DELETED_FLAG = '0' AND T1.STATUS = '1'
				 WHERE T0.DELETED_FLAG = '0' AND T0.STATUS = '1' AND T0.PIG_TYPE = 2 AND T0.PIG_CLASS = 9 AND T0.PARITY >= 8 
				 AND T1.HOUSE_TYPE = 6 
				 AND T0.FARM_ID = ${farmId}  
			]]>
	</select>
	
	<select id="productionAbnormalByWean" resultType="map">
			<![CDATA[ 
				SELECT 1 SORT_NBR,CONCAT('哺乳28天以上母猪') MESSAGE,COUNT(*) PIG_QTY
				 FROM pp_v_pig T0
				 INNER JOIN (
					SELECT T.PIG_ID,T.FARM_ID,T.PARITY,MAX(T.DELIVERY_DATE) DELIVERY_DATE  FROM pp_l_bill_delivery T WHERE T.DELETED_FLAG = '0' AND T.STATUS = '1' 
					GROUP BY T.PIG_ID,T.PARITY
				 ) T1
				 ON T0.FARM_ID = T1.FARM_ID AND T0.PIG_ID = T1.PIG_ID AND T0.PARITY = T1.PARITY 
				 WHERE T0.FARM_ID = ${farmId} AND T0.DELETED_FLAG = '0' AND T0.STATUS = '1' AND T0.PIG_TYPE = 2 AND T0.PIG_CLASS = 10 AND DATEDIFF(DATE(NOW()),T1.DELIVERY_DATE) >= 28
				 UNION ALL
				 SELECT 2 SORT_NBR,CONCAT('无产活健仔母猪') MESSAGE,COUNT(*) PIG_QTY
				 FROM pp_v_pig T0
				 INNER JOIN (
					SELECT T.PIG_ID,T.FARM_ID,T.PARITY,T.HEALTHY_NUM  FROM pp_l_bill_delivery T WHERE T.DELETED_FLAG = '0' AND T.STATUS = '1' 
					GROUP BY T.PIG_ID,T.PARITY
				 ) T1
				 ON T0.FARM_ID = T1.FARM_ID AND T0.PIG_ID = T1.PIG_ID AND T0.PARITY = T1.PARITY 
				 WHERE T0.FARM_ID = ${farmId} AND T0.DELETED_FLAG = '0' AND T0.STATUS = '1' AND T0.PIG_TYPE = 2 AND T0.PIG_CLASS = 10 AND T1.HEALTHY_NUM <= 0
				 UNION ALL
				 SELECT 3 SORT_NBR,CONCAT('人工助产母猪') MESSAGE,COUNT(*) PIG_QTY
				 FROM pp_v_pig T0
				 INNER JOIN (
					SELECT T.PIG_ID,T.FARM_ID,T.PARITY,T.DELIVERY_TYPE  FROM pp_l_bill_delivery T WHERE T.DELETED_FLAG = '0' AND T.STATUS = '1' 
					GROUP BY T.PIG_ID,T.PARITY
				 ) T1
				 ON T0.FARM_ID = T1.FARM_ID AND T0.PIG_ID = T1.PIG_ID AND T0.PARITY = T1.PARITY 
				 WHERE T0.FARM_ID = ${farmId} AND T0.DELETED_FLAG = '0' AND T0.STATUS = '1' AND T0.PIG_TYPE = 2 AND T0.PIG_CLASS = 10 AND T1.DELIVERY_TYPE = 'Y'
			]]>
	</select>
	
	<select id="productionAbnormalBySell" resultType="map">
			<![CDATA[ 
			
				SELECT 1 SORT_NBR,CONCAT('7天内应转保育数量') MESSAGE,COUNT(*) PIG_QTY
				FROM pp_l_pig T0
				LEFT JOIN cd_o_pork_pig T1
				ON T0.FARM_ID = T1.FARM_ID AND T0.MATERIAL_ID = T1.MATERIAL_ID
				WHERE T0.PIG_TYPE = '3' AND T0.PIG_CLASS BETWEEN 12 AND 14
				AND T0.DELETED_FLAG = '0' AND DATEDIFF(DATE(NOW()),T0.BIRTH_DATE )>= T1.CHILD_CARE_DAY_AGE - 7
				AND T0.FARM_ID = ${farmId}
				UNION ALL
				SELECT 2 SORT_NBR,CONCAT('7天内应转育肥数量') MESSAGE,COUNT(*) PIG_QTY
				FROM pp_l_pig T0
				LEFT JOIN cd_o_pork_pig T1
				ON T0.FARM_ID = T1.FARM_ID AND T0.MATERIAL_ID = T1.MATERIAL_ID
				WHERE T0.PIG_TYPE = '3' AND T0.PIG_CLASS = 15
				AND T0.DELETED_FLAG = '0' AND DATEDIFF(DATE(NOW()),T0.BIRTH_DATE )>= T1.FATTEN_DAY_AGE - 7
				AND T0.FARM_ID = ${farmId}
				UNION ALL
				SELECT 3 SORT_NBR,'日龄达到可销售数量'  MESSAGE,COUNT(*) PIG_QTY
				FROM pp_l_pig T0
				LEFT JOIN cd_o_pork_pig T1
				ON T0.FARM_ID = T1.FARM_ID AND T0.MATERIAL_ID = T1.MATERIAL_ID
				WHERE T0.PIG_TYPE = '3' AND T0.PIG_CLASS = 16
				AND T0.DELETED_FLAG = '0' AND DATEDIFF(DATE(NOW()),T0.BIRTH_DATE )>= T1.SELL_DAY_AGE - 7
				AND T0.FARM_ID = ${farmId}
			]]>
	</select>
	<select id="productionAbnormalByObsolete" resultType="map">
			<![CDATA[ 
				-- {0}胎以上的老龄母猪
				SELECT IFNULL(T0.SORT_NBR,T.SORT_NBR)SORT_NBR,REPLACE(IFNULL(T0.OBSOLETE_STANDARD,T.OBSOLETE_STANDARD),'{0}',IFNULL(T0.PARAM1,T.PARAM1)) MESSAGE,SUM(IF(T1.PIG_ID IS NULL,0,1)) PIG_QTY
				FROM cd_m_pig_obsolete_module T
				LEFT JOIN cd_m_pig_obsolete T0
				ON T.OBSOLETE_CODE = T0.OBSOLETE_CODE AND T0.FARM_ID = ${farmId}
				LEFT JOIN pp_v_pig T1
				ON 1 = 1 AND T1.FARM_ID = ${farmId} AND T1.DELETED_FLAG = '0' AND T1.PIG_TYPE = 2 AND T1.PARITY >= IFNULL(T0.PARAM1,T.PARAM1)
				WHERE T.DELETED_FLAG = '0' AND T.OBSOLETE_CODE = 'SBS_0001' AND T1.PIG_CLASS < 19
				UNION ALL
				-- 连续{0}次返情、流产的母猪
				SELECT IFNULL(T0.SORT_NBR,T.SORT_NBR)SORT_NBR,REPLACE(REPLACE(IFNULL(T0.OBSOLETE_STANDARD,T.OBSOLETE_STANDARD),'{0}',T0.PARAM1),'{1}',T0.PARAM2) MESSAGE,IFNULL(COUNT(TT2.QTY),0) QTY 
				FROM CD_M_PIG_OBSOLETE_MODULE T
				LEFT JOIN CD_M_PIG_OBSOLETE T0
				ON T.OBSOLETE_CODE = T0.OBSOLETE_CODE AND T0.FARM_ID = ${farmId} 
				LEFT JOIN (
					SELECT *,COUNT(1) QTY FROM (
					SELECT TT1.*,TT2.*,(
						SELECT 
							MAX(T1.SORT_NBR) LAST_MAX_SORT_NBR
						FROM PP_L_BILL_PREGNANCY_CHECK T1 
						WHERE T1.DELETED_FLAG = '0' 
						AND T1.PREGNANCY_RESULT IN (2,4,5,6) 
						AND T1.FARM_ID = TT1.FARM_ID AND T1.PIG_ID = TT1.PIG_ID  
						AND T1.SORT_NBR < TT1.SORT_NBR 
						AND T1.FARM_ID = ${farmId} 
					) LAST_MAX_SORT_NBR,(
						SELECT 
							MIN(T1.SORT_NBR) AFTER_MIN_SORT_NBR
						FROM PP_L_BILL_PREGNANCY_CHECK T1 
						WHERE T1.DELETED_FLAG = '0' 
						AND T1.PREGNANCY_RESULT IN (2,4,5,6) 
						AND T1.FARM_ID = TT1.FARM_ID AND T1.PIG_ID = TT1.PIG_ID  
						AND T1.SORT_NBR > TT1.SORT_NBR 
						AND T1.FARM_ID = ${farmId} 
					) AFTER_MIN_SORT_NBR
					FROM (
						SELECT 
							T1.FARM_ID,T1.PIG_ID,T1.SORT_NBR,T1.PREGNANCY_RESULT 
						FROM PP_L_BILL_PREGNANCY_CHECK T1 
						INNER JOIN PP_L_PIG T9 
						ON T1.FARM_ID = T9.FARM_ID AND T1.PIG_ID = T9.ROW_ID AND T9.DELETED_FLAG = '0' AND T9.PIG_TYPE = 2 AND T9.LEAVE_DATE IS NULL 
						WHERE T1.DELETED_FLAG = '0' 
						AND T1.PREGNANCY_RESULT IN (2,4,5,6)  
						/*AND T9.PIG_CLASS = 11*/
						/*AND T1.PIG_ID = 00000000000000179437 */
						AND T1.FARM_ID = ${farmId} 
					) TT1 
					LEFT JOIN (
						SELECT IFNULL(T7.SORT_NBR,T6.SORT_NBR) MODULE_SORT_NBR,
						REPLACE(REPLACE(IFNULL(T7.OBSOLETE_STANDARD,T6.OBSOLETE_STANDARD),'{0}',IFNULL(T7.PARAM1,T6.PARAM1)),'{1}',IFNULL(T7.PARAM2,T6.PARAM2)) MESSAGE,
						IFNULL(T7.OBSOLETE_CODE,T6.OBSOLETE_CODE) OBSOLETE_CODE,IFNULL(T7.PARAM1,T6.PARAM1) PARAM1 ,IFNULL(T7.PARAM2,T6.PARAM2) PARAM2 
						FROM CD_M_PIG_OBSOLETE_MODULE T6
						LEFT JOIN CD_M_PIG_OBSOLETE T7
						ON T6.OBSOLETE_CODE = T7.OBSOLETE_CODE AND T7.FARM_ID = ${farmId} 
						WHERE T6.DELETED_FLAG = '0' 
						AND IFNULL(T7.OBSOLETE_CODE,T6.OBSOLETE_CODE) = 'SBS_0002' 	
					) TT2 ON 1=1 
					HAVING LAST_MAX_SORT_NBR IS NOT NULL 
					AND SORT_NBR - LAST_MAX_SORT_NBR = 1 /*存在连续*/
					AND IF(PARAM1>2 ,AFTER_MIN_SORT_NBR - SORT_NBR = 1 ,'1=1') /*多个连续*/
					) TTT
					GROUP BY TTT.FARM_ID,TTT.PIG_ID 
				) TT2 
				ON 1=1 
				WHERE T0.OBSOLETE_CODE = 'SBS_0002' 
				UNION ALL
				-- 连续{0}胎产仔数在{1}头以下
				SELECT IFNULL(T0.SORT_NBR,T.SORT_NBR)SORT_NBR,REPLACE(REPLACE(IFNULL(T0.OBSOLETE_STANDARD,T.OBSOLETE_STANDARD),'{0}',T0.PARAM1),'{1}',T0.PARAM2) MESSAGE,SUM(IF(TT.QTY IS NULL,0,1)) PIG_QTY 
				FROM CD_M_PIG_OBSOLETE_MODULE T
				LEFT JOIN CD_M_PIG_OBSOLETE T0
				ON T.OBSOLETE_CODE = T0.OBSOLETE_CODE AND T0.FARM_ID = ${farmId} 
				LEFT JOIN (
					SELECT T3.FARM_ID ,T3.PIG_ID,t3.SORT_NBR,t3.MESSAGE ,T3.PARAM1 , T3.PARAM2 , IF(T3.PARAM1 = 2 , COUNT(1)+1 , COUNT(1)+2 ) QTY 
					FROM (
						SELECT T2.FARM_ID ,T2.PIG_ID ,T2.PARITY ,t3.SORT_NBR ,t3.MESSAGE ,T3.PARAM1 , T3.PARAM2 , 
						(
							SELECT MAX(T1.PARITY) MAX_PARITY
							FROM PP_L_BILL_DELIVERY T1 
							LEFT JOIN (
								SELECT IFNULL(T7.SORT_NBR,T6.SORT_NBR)SORT_NBR,IFNULL(T7.OBSOLETE_CODE,T6.OBSOLETE_CODE) OBSOLETE_CODE,IFNULL(T7.PARAM1,T6.PARAM1) PARAM1 ,IFNULL(T7.PARAM2,T6.PARAM2) PARAM2 
								FROM CD_M_PIG_OBSOLETE_MODULE T6
								LEFT JOIN CD_M_PIG_OBSOLETE T7
								ON T6.OBSOLETE_CODE = T7.OBSOLETE_CODE AND T7.FARM_ID = ${farmId}
								WHERE T6.DELETED_FLAG = '0' 
								AND IFNULL(T7.OBSOLETE_CODE,T6.OBSOLETE_CODE) = 'SBS_0003'
							) T3 ON 1 = 1 
							
							WHERE T1.DELETED_FLAG = '0' 
							AND T1.FARM_ID = ${farmId} 
							AND T1.FARM_ID = T2.FARM_ID AND T1.PIG_ID = T2.PIG_ID AND T1.PARITY < T2.PARITY 
							AND (IFNULL(T1.HEALTHY_NUM, 0) + IFNULL(T1.WEAK_NUM, 0) + IFNULL(T1.STILLBIRTH_NUM, 0) + IFNULL(T1.MUTANT_NUM, 0) + IFNULL(T1.MUMMY_NUM, 0) + IFNULL(T1.BLACK_NUM, 0)) <= T3.PARAM2 
							ORDER BY T1.PIG_ID,T1.PARITY 
						) LAST_MAX_PARITY,/*找到前一个满足条件的胎次*/
						(
							SELECT MIN(T1.PARITY) MAX_PARITY
							FROM PP_L_BILL_DELIVERY T1 
							LEFT JOIN (
								SELECT IFNULL(T7.SORT_NBR,T6.SORT_NBR)SORT_NBR,IFNULL(T7.OBSOLETE_CODE,T6.OBSOLETE_CODE) OBSOLETE_CODE,IFNULL(T7.PARAM1,T6.PARAM1) PARAM1 ,IFNULL(T7.PARAM2,T6.PARAM2) PARAM2 
								FROM CD_M_PIG_OBSOLETE_MODULE T6
								LEFT JOIN CD_M_PIG_OBSOLETE T7
								ON T6.OBSOLETE_CODE = T7.OBSOLETE_CODE AND T7.FARM_ID = ${farmId} 
								WHERE T6.DELETED_FLAG = '0' 
								AND IFNULL(T7.OBSOLETE_CODE,T6.OBSOLETE_CODE) = 'SBS_0003'
							) T3 ON 1 = 1 
							
							WHERE T1.DELETED_FLAG = '0' 
							AND T1.FARM_ID = ${farmId} 
							AND T1.FARM_ID = T2.FARM_ID AND T1.PIG_ID = T2.PIG_ID AND T1.PARITY > T2.PARITY 
							AND (IFNULL(T1.HEALTHY_NUM, 0) + IFNULL(T1.WEAK_NUM, 0) + IFNULL(T1.STILLBIRTH_NUM, 0) + IFNULL(T1.MUTANT_NUM, 0) + IFNULL(T1.MUMMY_NUM, 0) + IFNULL(T1.BLACK_NUM, 0)) <= T3.PARAM2 
							ORDER BY T1.PIG_ID,T1.PARITY 
						) AFTER_MIN_PARITY /*找到后一个满足条件的胎次*/
						
						FROM (
							SELECT T1.FARM_ID,T1.PIG_ID,T1.PARITY,
							  (IFNULL(T1.HEALTHY_NUM, 0) + IFNULL(T1.WEAK_NUM, 0) + IFNULL(T1.STILLBIRTH_NUM, 0) + IFNULL(T1.MUTANT_NUM, 0) + IFNULL(T1.MUMMY_NUM, 0) + IFNULL(T1.BLACK_NUM, 0)) FARROWING 
							FROM PP_L_BILL_DELIVERY T1 
							LEFT JOIN (
								SELECT IFNULL(T7.SORT_NBR,T6.SORT_NBR)SORT_NBR,IFNULL(T7.OBSOLETE_CODE,T6.OBSOLETE_CODE) OBSOLETE_CODE,IFNULL(T7.PARAM1,T6.PARAM1) PARAM1 ,IFNULL(T7.PARAM2,T6.PARAM2) PARAM2 
								FROM CD_M_PIG_OBSOLETE_MODULE T6
								LEFT JOIN CD_M_PIG_OBSOLETE T7
								ON T6.OBSOLETE_CODE = T7.OBSOLETE_CODE AND T7.FARM_ID = ${farmId} 
								WHERE T6.DELETED_FLAG = '0' 
								AND IFNULL(T7.OBSOLETE_CODE,T6.OBSOLETE_CODE) = 'SBS_0003'
							) T3 ON 1 = 1 
							INNER JOIN PP_L_PIG T9 
							ON T1.FARM_ID = T9.FARM_ID AND T1.PIG_ID = T9.ROW_ID AND T9.DELETED_FLAG = '0' AND T9.PIG_TYPE = 2 AND T9.LEAVE_DATE IS NULL 
							WHERE T1.DELETED_FLAG = '0' 
							AND T1.FARM_ID = ${farmId} 
							AND (IFNULL(T1.HEALTHY_NUM, 0) + IFNULL(T1.WEAK_NUM, 0) + IFNULL(T1.STILLBIRTH_NUM, 0) + IFNULL(T1.MUTANT_NUM, 0) + IFNULL(T1.MUMMY_NUM, 0) + IFNULL(T1.BLACK_NUM, 0)) <= T3.PARAM2 
							ORDER BY T1.PIG_ID,T1.PARITY 
						) T2 
						LEFT JOIN (
							SELECT IFNULL(T7.SORT_NBR,T6.SORT_NBR)SORT_NBR,
							REPLACE(REPLACE(IFNULL(t7.OBSOLETE_STANDARD,t6.OBSOLETE_STANDARD),'{0}',IFNULL(T7.PARAM1,T6.PARAM1)),'{1}',IFNULL(T7.PARAM2,T6.PARAM2)) MESSAGE,
							IFNULL(T7.OBSOLETE_CODE,T6.OBSOLETE_CODE) OBSOLETE_CODE,IFNULL(T7.PARAM1,T6.PARAM1) PARAM1 ,IFNULL(T7.PARAM2,T6.PARAM2) PARAM2 
							FROM CD_M_PIG_OBSOLETE_MODULE T6
							LEFT JOIN CD_M_PIG_OBSOLETE T7
							ON T6.OBSOLETE_CODE = T7.OBSOLETE_CODE AND T7.FARM_ID = ${farmId} 
							WHERE T6.DELETED_FLAG = '0' 
							AND IFNULL(T7.OBSOLETE_CODE,T6.OBSOLETE_CODE) = 'SBS_0003'
						) T3 ON 1 = 1
					) T3 
					WHERE 
					T3.PARITY - T3.LAST_MAX_PARITY = 1 /* 满足条件--胎次相连 */
					AND IF(T3.PARAM1 <> 2 , T3.AFTER_MIN_PARITY - T3.PARITY = 1 , '1=1' ) /* 满足条件--胎次>=3次相连 */
					GROUP BY T3.FARM_ID,T3.PIG_ID,T3.PARITY - T3.LAST_MAX_PARITY 
					HAVING PARAM1 <= QTY 
				) TT ON 1=1 
				WHERE T0.OBSOLETE_CODE = 'SBS_0003' 
				UNION ALL
				-- 断奶后{0}天不发情
				SELECT IFNULL(T0.SORT_NBR,T.SORT_NBR)SORT_NBR,REPLACE(IFNULL(T0.OBSOLETE_STANDARD,T.OBSOLETE_STANDARD),'{0}',T0.PARAM1) MESSAGE,SUM(IF(T1.PIG_ID IS NULL,0,1)) PIG_QTY 
				FROM cd_m_pig_obsolete_module T
				LEFT JOIN cd_m_pig_obsolete T0
				ON T.OBSOLETE_CODE = T0.OBSOLETE_CODE AND T0.FARM_ID = ${farmId}
				LEFT JOIN(
					SELECT T.PIG_ID,DATEDIFF(DATE(NOW()),DATE(T.LAST_CLASS_DATE) ) DAY_QTY,T0.PARAM1
					FROM pp_v_pig T 
					LEFT JOIN (
						SELECT IFNULL(T0.SORT_NBR,T.SORT_NBR)SORT_NBR,IFNULL(T0.OBSOLETE_CODE,T.OBSOLETE_CODE)OBSOLETE_CODE,IFNULL(T0.PARAM1,T.PARAM1) PARAM1 ,IFNULL(T0.PARAM2,T.PARAM2) PARAM2 
							FROM cd_m_pig_obsolete_module T
							LEFT JOIN cd_m_pig_obsolete T0
							ON T.OBSOLETE_CODE = T0.OBSOLETE_CODE AND T0.FARM_ID = ${farmId}
							WHERE T0.OBSOLETE_CODE = 'SBS_0004'
					) T0
					ON 1 = 1 
					WHERE T.PIG_TYPE = 2 AND T.PIG_CLASS = 11 AND T.FARM_ID = ${farmId}
					HAVING DAY_QTY > PARAM1
					
				) T1
				ON 1 = 1
				WHERE T0.OBSOLETE_CODE = 'SBS_0004'
				UNION ALL
				-- {0}月龄不发情的后备母猪
				SELECT IFNULL(T0.SORT_NBR,T.SORT_NBR)SORT_NBR,REPLACE(IFNULL(T0.OBSOLETE_STANDARD,T.SORT_NBR),'{0}',IFNULL(T0.PARAM1,T.SORT_NBR)) MESSAGE,SUM(IF(T1.PIG_ID IS NULL,0,1)) PIG_QTY 
				FROM cd_m_pig_obsolete_module T
				LEFT JOIN cd_m_pig_obsolete T0
				ON T.OBSOLETE_CODE = T0.OBSOLETE_CODE AND T0.FARM_ID = ${farmId}
				LEFT JOIN(
					SELECT T.PIG_ID,TIMESTAMPDIFF(MONTH,T.BIRTH_DATE,DATE(NOW()) ) DAY_QTY,T0.PARAM1
					FROM pp_v_pig T 
					LEFT JOIN (
						SELECT IFNULL(T0.SORT_NBR,T.SORT_NBR)SORT_NBR,IFNULL(T0.OBSOLETE_CODE,T.OBSOLETE_CODE)OBSOLETE_CODE,IFNULL(T0.PARAM1,T.PARAM1) PARAM1 ,IFNULL(T0.PARAM2,T.PARAM2) PARAM2 
						FROM cd_m_pig_obsolete_module T
						LEFT JOIN cd_m_pig_obsolete T0
						ON T.OBSOLETE_CODE = T0.OBSOLETE_CODE AND T0.FARM_ID = ${farmId}
					) T0
					ON 1 = 1 AND T0.OBSOLETE_CODE = 'SBS_0007'
					WHERE T.PIG_TYPE = 2 AND T.PIG_CLASS BETWEEN 3 AND 4 AND T.FARM_ID = ${farmId}
					HAVING DAY_QTY > PARAM1
					
				) T1
				ON 1 = 1
				WHERE T0.OBSOLETE_CODE = 'SBS_0007'
			]]>
	</select>
	<!-- 母猪群分娩异常明细  -->
	<select id="searchDeliveryExceptionDetail" resultType="map">
			<![CDATA[ 
				SELECT 
					IF(COUNT(1)>0,TIMESTAMPDIFF(WEEK,B.BEGIN_DATE,A.TOWORK_DATE)+1,0) WEEK_INDEX,
					SUM(IF(A.PIG_CLASS = 6 ,1,0)) FQ,
					SUM(IF(A.PIG_CLASS = 7 ,1,0)) LC,
					SUM(IF(A.PIG_CLASS = 8 ,1,0)) KH,
					SUM(IF(A.PIG_CLASS = 9 ,1,0)) RS,
					A.SWINERY_ID,A.PIG_CLASS,
					A.TOWORK_DATE,
					A.BILL_ID,
					GROUP_CONCAT(A.PIG_ID) CONCAT_PIGID,
					GROUP_CONCAT('[',E.EAR_BRAND,IF(A.PIG_CLASS = 6 ,'-返情',IF(A.PIG_CLASS = 7,'-流产',IF(A.PIG_CLASS = 8,'-空怀',''))),']') EAR_SOW_EXCEPTION,
					GROUP_CONCAT('[',E.EAR_BRAND,IF(A.PIG_CLASS = 6 ,'-返情-',IF(A.PIG_CLASS = 7,'-流产-',IF(A.PIG_CLASS = 8,'-空怀-',''))),DATE_FORMAT(A.TOWORK_DATE,'%Y:%m:%d'),']') EAR_SOWEAR_EXCEPTION_DATA,
					GROUP_CONCAT(G.EAR_BRAND) EAR_BOAR,
					GROUP_CONCAT(E.EAR_BRAND,'-',G.EAR_BRAND) DETAIL,
					GROUP_CONCAT(E.EAR_BRAND,'-',IF(A.SWINERY_ID= H.SWINERY_ID,IF(H.PIG_CLASS=23,'死亡',''),IF(H.PIG_CLASS=24,'淘汰',IF(H.PIG_CLASS=25,'销售','再配'))),'-',DATE_FORMAT(H.TOWORK_DATE,'%Y:%m:%d')) EAR_WHEREABOUTS,
		GROUP_CONCAT(E.EAR_BRAND,'-',IF(D.PIG_CLASS=6,'返请',IF(D.PIG_CLASS=7,'流产',IF(D.PIG_CLASS=8,'空怀',IF(D.PIG_CLASS=23,'死亡',IF(D.PIG_CLASS=24,'淘汰',IF(D.PIG_CLASS=25,'销售',IF(D.PIG_CLASS=9,'妊娠','其他')))))))) NEW_PIGCLASS
					
				FROM PP_L_BILL_TOWORK A 
				LEFT JOIN PP_M_SWINERY B
				ON A.DELETED_FLAG = B.DELETED_FLAG AND A.STATUS = B.STATUS AND A.FARM_ID = B.FARM_ID AND A.SWINERY_ID = B.ROW_ID
				LEFT JOIN PP_L_BILL_BREED C
				ON A.DELETED_FLAG = C.DELETED_FLAG AND A.STATUS = C.STATUS AND A.FARM_ID = C.FARM_ID AND  A.BILL_ID = C.BILL_ID AND A.PIG_ID = C.PIG_ID
				LEFT JOIN PP_L_PIG D 
				ON A.DELETED_FLAG = D.DELETED_FLAG AND A.STATUS = D.STATUS AND A.FARM_ID = D.FARM_ID AND A.PIG_ID  = D.ROW_ID 
				LEFT JOIN PP_L_EAR_CODE E
				ON A.DELETED_FLAG = E.DELETED_FLAG AND A.STATUS = E.STATUS AND A.FARM_ID = E.FARM_ID AND D.EAR_CODE_ID = E.ROW_ID
				LEFT JOIN PP_L_PIG F
				ON A.DELETED_FLAG = F.DELETED_FLAG AND A.STATUS = F.STATUS AND A.FARM_ID = F.FARM_ID AND C.BREED_BOAR_FIRST  = F.ROW_ID 
				LEFT JOIN PP_L_EAR_CODE G
				ON A.DELETED_FLAG = G.DELETED_FLAG AND A.STATUS = G.STATUS AND A.FARM_ID = G.FARM_ID AND F.EAR_CODE_ID = G.ROW_ID
				LEFT JOIN PP_L_BILL_TOWORK H
				ON A.ROW_ID = H.CHANGE_PIG_CLASS_ID
				WHERE A.DELETED_FLAG = 0 
				AND A.FARM_ID = ${farmId}
				AND A.SWINERY_ID IS NOT NULL 
				AND A.PIG_CLASS BETWEEN 6 AND 8
				AND A.SWINERY_ID = ${swineryId}
				GROUP BY A.TOWORK_DATE,A.SWINERY_ID
				ORDER BY A.TOWORK_DATE 
			]]>
	</select>
	
	<!-- 母猪群分娩异常 周次 数量  -->
	<select id="searchDeliveryExceptionDetailThePigWhereabouts" resultType="map">
		<foreach collection="list" item="item" index="index" open="" close="" separator=" UNION ">
			<![CDATA[ 
				SELECT 
					${date} WEEK_INDEX,#周次
					SUM(IF(a.pig_class = 6 ,1,0)) FQ,#返情
					SUM(IF(a.pig_class = 7 ,1,0)) LC,#流产
					SUM(IF(a.pig_class = 8 ,1,0)) KH,#空怀
					SUM(IF(a.pig_class = 9 ,1,0)) RS,#妊娠
					a.SWINERY_ID,a.pig_id,a.pig_class,a.TOWORK_DATE,A.BILL_ID
				FROM pp_l_bill_towork a 
				LEFT JOIN pp_m_swinery b
				ON a.DELETED_FLAG = b.DELETED_FLAG AND a.STATUS = b.STATUS AND a.FARM_ID = b.FARM_ID AND a.SWINERY_ID = b.ROW_ID
				WHERE a.DELETED_FLAG = 0 AND a.FARM_ID = ${farmId} 
				AND a.SWINERY_ID IS NOT NULL AND a.pig_class BETWEEN 6 AND 9 
				AND a.TOWORK_DATE < DATE_ADD(b.BEGIN_DATE,INTERVAL ${date} WEEK)
				AND a.TOWORK_DATE > DATE_ADD(b.BEGIN_DATE,INTERVAL ${date}-1 WEEK)
				AND A.SWINERY_ID = ${swineryId}
				GROUP BY A.BILL_ID,a.SWINERY_ID
				ORDER BY a.TOWORK_DATE DESC

			]]>
		</foreach>
	</select>
	
	<!-- 栏舍周转  -->
	<select id="searchChangePigpenAndHouseByDateType" resultType="map">
			<![CDATA[ 
			SELECT 
					T.HOUSE_NAME,
					IF(T.NOW_NUM > 0,'在养',IF(T.MISTIMING_DAY IS NULL,'未存猪',CONCAT('空栏',T.MAX_LEAVE_CLASS_DATE,'天'))) HOUSE_CLASS,
					IF(T.SWINERY_ID IS NULL,0,LENGTH(T.SWINERY_ID)-LENGTH(REPLACE(T.SWINERY_ID ,',',''))+1) SWINERY_NUM,
					T.START_NUM , 
					T.BITH_NUM ,
					T.INTO_NUM ,
					T.OUT_NUM ,
					T.DIE_NUM ,
					T.NOW_NUM 
			FROM (
				SELECT 
					C.HOUSE_NAME HOUSE_NAME,
					a.HOUSE_ID,
					TIMESTAMPDIFF(DAY,MAX(G.LAST_CLASS_DATE),NOW()) MAX_LEAVE_CLASS_DATE,
					SUM(IF(A.CHANGE_HOUSE_DATE <= '${startDate}' AND D.CHANGE_HOUSE_DATE >= '${startDate}',1,0)) START_NUM,
					SUM(IF(A.CHANGE_HOUSE_DATE >= '${startDate}' AND F.CHANGE_HOUSE_DATE IS NULL,1,0)) BITH_NUM,
					SUM(IF(A.CHANGE_HOUSE_DATE >= '${startDate}' AND A.HOUSE_ID <> F.HOUSE_ID,1,0)) INTO_NUM,
					SUM(IF(A.CHANGE_HOUSE_DATE <= '${startDate}' AND D.CHANGE_HOUSE_DATE > '${startDate}' AND A.HOUSE_ID <> D.HOUSE_ID,1,0)) OUT_NUM,
					SUM(IF(E.LEAVE_DATE >= '${startDate}' AND E.LEAVE_TYPE IN (2,3,4),1,0)) DIE_NUM,
					SUM(IF(D.CHANGE_HOUSE_DATE IS NULL AND E.LEAVE_DATE IS NULL AND A.CHANGE_HOUSE_DATE IS NOT NULL ,1,0 )) NOW_NUM,
					TIMESTAMPDIFF(DAY, MAX(D.CHANGE_HOUSE_DATE),NOW()) MISTIMING_DAY,
					GROUP_CONCAT(DISTINCT IF(D.CHANGE_HOUSE_DATE > '${startDate}',H.SWINERY_ID,NULL)) SWINERY_ID
				FROM PP_O_HOUSE C 
				LEFT JOIN PP_L_BILL_CHANGE_HOUSE A 
				ON A.DELETED_FLAG = C.DELETED_FLAG AND A.STATUS = C.STATUS AND A.FARM_ID = C.FARM_ID AND A.HOUSE_ID = C.ROW_ID
				LEFT JOIN PP_L_BILL_CHANGE_HOUSE D
				ON A.DELETED_FLAG = D.DELETED_FLAG AND A.STATUS = D.STATUS AND A.FARM_ID = D.FARM_ID AND A.ROW_ID = D.CHANGE_HOUSE_ID
				LEFT JOIN PP_L_BILL_CHANGE_HOUSE F
				ON A.DELETED_FLAG = F.DELETED_FLAG AND A.STATUS = F.STATUS AND A.FARM_ID = F.FARM_ID AND  F.ROW_ID = A.CHANGE_HOUSE_ID
				LEFT JOIN PP_L_BILL_LEAVE E
				ON A.DELETED_FLAG = E.DELETED_FLAG AND A.STATUS = E.STATUS AND A.FARM_ID = E.FARM_ID AND A.PIG_ID = E.PIG_ID AND A.HOUSE_ID = E.HOUSE_ID
				LEFT JOIN PP_L_PIG G
				ON A.DELETED_FLAG = G.DELETED_FLAG AND A.STATUS = G.STATUS AND A.FARM_ID = G.FARM_ID AND A.PIG_ID = G.ROW_ID AND G.PIG_CLASS > 18 AND G.PIG_CLASS <> 24 
				LEFT JOIN PP_L_BILL_CHANGE_SWINERY H 
				ON A.DELETED_FLAG = H.DELETED_FLAG AND A.STATUS = H.STATUS AND A.FARM_ID = H.FARM_ID AND A.PIG_ID = H.PIG_ID AND A.BILL_ID = H.BILL_ID 
				WHERE C.DELETED_FLAG = 0 
				AND C.FARM_ID = ${farmId}

				AND C.HOUSE_NAME IS NOT NULL
			]]>
			<!-- AND A.SWINERY_ID IS NOT NULL  -->
			<!-- 生产猪 -->
			<if test='pigClassType=="productionPig"'>
				<!-- AND A.PIG_TYPE IN ('1','2') -->
				AND C.HOUSE_TYPE NOT IN (8,9,11,12,13,14)
			</if>
			<!-- 哺乳猪 -->
			<if test='pigClassType=="lactationPig"'>
				AND A.PIG_TYPE IN ('3')
				AND A.PIG_CLASS IN (${pigClass})
				<!-- AND C.HOUSE_TYPE NOT IN (6) -->
			</if>
			<!-- 保育 -->
			<if test='pigClassType=="nursingPig"'>
			<!-- 	AND A.PIG_TYPE IN ('3') AND A.PIG_CLASS IN (${pigClass}) -->
				AND C.HOUSE_TYPE  IN (8)
			</if>
			<!-- 育肥 -->
			<if test='pigClassType=="fatteningPig"'>
			<!-- 	AND A.PIG_TYPE IN ('3')	AND A.PIG_CLASS IN (${pigClass}) -->
			AND C.HOUSE_TYPE  IN (9)
			</if>
			
			<![CDATA[ 
				GROUP BY C.ROW_ID
			) T
			
			]]>
	</select>
	
	<!-- 综合指标 期间内  生产母猪   生产天数之和-->
	<select id="searchNonProductionDays" resultType="map">
			<![CDATA[ 
			SELECT 
					IFNULL(SUM(IF(A.PIG_CLASS IN(9,10),0,TIMESTAMPDIFF(DAY,A.TOWORK_DATE,IFNULL(B.TOWORK_DATE,NOW())))),0) DAYS
				FROM PP_L_BILL_TOWORK A
				LEFT JOIN PP_L_BILL_TOWORK B 
					ON A.FARM_ID = B.FARM_ID AND A.DELETED_FLAG = B.DELETED_FLAG AND A.STATUS = B.STATUS AND A.ROW_ID=B.CHANGE_PIG_CLASS_ID
				LEFT JOIN PP_L_BILL_TOWORK C 
					ON A.FARM_ID = C.FARM_ID AND A.DELETED_FLAG = C.DELETED_FLAG AND A.STATUS = C.STATUS AND C.ROW_ID=A.CHANGE_PIG_CLASS_ID
				WHERE A.DELETED_FLAG=0 AND A.STATUS=1 
					AND A.PIG_CLASS BETWEEN 4 AND 11 
					AND (A.PIG_CLASS <> B.PIG_CLASS OR B.PIG_CLASS IS NULL )
					AND A.FARM_ID=  ${farmId}  
					AND A.TOWORK_DATE >= DATE_ADD(DATE(NOW()),INTERVAL -1  ${dateType}) 
			]]>
	</select>
	
	<!-- 综合指标 获取 期初 的母猪数量-->
	<select id="searchDayIndexByDate" resultType="map">
			<![CDATA[ 
			SELECT 
				DATE_ADD(DATE(NOW()),INTERVAL -1 ${dateType}) DATE, 
				IFNULL(COUNT(1),0) MZ_PIG,
				TIMESTAMPDIFF(DAY, DATE_ADD(DATE(NOW()),INTERVAL -1 ${dateType}),NOW()) TIMESTAMPDIFF
			FROM(
				SELECT IF(P2.TOWORK_DATE IS NULL,NOW(),DATE_ADD(P2.TOWORK_DATE, INTERVAL -1 DAY)) end_date
				FROM pp_l_bill_towork p 
				LEFT JOIN pp_l_bill_towork p2 
				  ON p.ROW_ID=p2.CHANGE_PIG_CLASS_ID AND p.FARM_ID=p2.FARM_ID AND p.DELETED_FLAG = p2.DELETED_FLAG
				LEFT JOIN PP_L_PIG P3
				ON p.FARM_ID=p3.FARM_ID AND P.STATUS = P3.STATUS AND P.PIG_ID = P3.ROW_ID
				WHERE  p.DELETED_FLAG = 0 AND p.STATUS = 1 
				 AND (p.PIG_CLASS< 19 OR P.PIG_CLASS = 24)
				 AND (P3.ORIGIN <> 3 OR P3.ORIGIN IS NULL) 
				 AND P.FARM_ID= ${farmId}
				 AND p.pig_type = 2
				 AND p.TOWORK_DATE <= DATE_ADD(DATE_ADD(DATE(NOW()),INTERVAL -1 ${dateType}),INTERVAL -${beforeDay} day) 
			 ) T1 WHERE T1.end_date >= DATE_ADD(DATE_ADD(DATE(NOW()),INTERVAL -1 ${dateType}),INTERVAL -${beforeDay} day)
			]]>
	</select>
	
	<!-- 综合指标 获取 最近 月或年 离场 的母猪数量-->
	<select id="searchDayIndexByLeaveDate" resultType="map">
			<![CDATA[ 
			SELECT 
				 DATE_ADD(DATE(NOW()),INTERVAL -1  ${dateType})  LEAVE_DATE,
				COUNT(1) LEAVE_SUM
			FROM pp_l_bill_leave a
			WHERE a.DELETED_FLAG = 0 AND a.PIG_TYPE= 2 AND (a.pig_class BETWEEN 4 AND 11 OR a.pig_class IN (24,25) )
				
				AND A.LEAVE_TYPE IN (1,2)
				AND a.FARM_ID = ${farmId} 
				AND a.LEAVE_DATE > DATE_ADD(DATE_ADD(DATE(NOW()),INTERVAL -1 ${dateType}),INTERVAL -${beforeDay} day)
			]]>
	</select>
		
	<!-- 综合指标 获取 期间内 转生产或入场即为生产母猪 的数量-->
	<select id="searchDayIndexByProductDate" resultType="map">
			<![CDATA[ 
			SELECT T.PRODUCT_DATE PRODUCT_DATE,SUM(T.PRODUCT_SUM) PRODUCT_SUM FROM (
				SELECT 
					DATE_ADD(DATE(NOW()),INTERVAL -1 ${dateType})  PRODUCT_DATE,
					COUNT(1) PRODUCT_SUM
					FROM pp_l_bill_reserve_product a 
				WHERE  a.DELETED_FLAG = 0 AND a.PIG_TYPE= 2 
					AND a.FARM_ID = ${farmId} 
					AND a.PRODUCT_DATE > DATE_ADD(NOW(),INTERVAL -1 ${dateType}) 
					UNION ALL
				SELECT 
					DATE_ADD(DATE(NOW()),INTERVAL -1 ${dateType})  PRODUCT_DATE,
					COUNT(1) PRODUCT_SUM
				FROM PP_L_PIG A 
				WHERE 
					A.DELETED_FLAG=0 
					AND A.STATUS=1 
					AND A.PIG_TYPE=2 
					AND a.ORIGIN_APP = 'EXCEL'
					AND A.FARM_ID=${farmId} 
					AND A.ENTER_DATE > DATE_ADD(DATE_ADD(DATE(NOW()),INTERVAL -1 ${dateType}),INTERVAL -${beforeDay} day)
					AND (A.ENTER_PIG_CLASS = 11 OR (A.ORIGIN_APP = 'EXCEL' AND A.ENTER_PIG_CLASS BETWEEN 4 AND 11))
				) T
			]]>
	</select>
		
	<!-- 综合指标 7天断配率 -->
	<select id="search7DayAlreadyBreedProbabilityByDate" resultType="map">
			<![CDATA[ 
			SELECT IFNULL(T.befor7/(T.befor7+t.all_pig)*100,0) wean_breed_of_7day 
			FROM 
			(
			SELECT 
				SUM(IF(TIMESTAMPDIFF(DAY,a.TOWORK_DATE,b.TOWORK_DATE)<=7,1,0)) befor7,
				SUM(IF(TIMESTAMPDIFF(DAY,a.TOWORK_DATE,IFNULL(b.TOWORK_DATE,NOW())) > 7,1,0)) after7,
				COUNT(1) all_pig
			 FROM pp_l_bill_towork a 
			LEFT JOIN pp_l_bill_towork b
			ON a.FARM_ID = b.FARM_ID AND a.DELETED_FLAG = b.DELETED_FLAG AND a.STATUS = b.STATUS AND a.ROW_ID=b.CHANGE_PIG_CLASS_ID
			LEFT JOIN pp_l_bill_towork c
			ON a.FARM_ID = c.FARM_ID AND a.DELETED_FLAG = c.DELETED_FLAG AND a.STATUS = c.STATUS AND c.ROW_ID= a.CHANGE_PIG_CLASS_ID
			WHERE a.DELETED_FLAG = 0 AND a.STATUS=1 
				AND a.FARM_ID= ${farmId}
				AND a.TOWORK_DATE >= DATE_ADD(NOW(),INTERVAL -1  ${dateType})  
				AND a.PIG_CLASS = 11 AND b.PIG_CLASS = 9
			) T
			]]>
	</select>
		
	<!-- 综合指标 分娩率 -->
	<select id="searchDeliveryProbabilityByDate" resultType="map">
			<![CDATA[ 
			SELECT 
			(
				(
				SELECT COUNT(1) FROM PP_L_BILL_DELIVERY A 
				WHERE A.DELETED_FLAG=0 AND A.STATUS = 1 AND A.FARM_ID= ${farmId}  AND A.DELIVERY_DATE >= DATE_ADD(NOW(),INTERVAL -1 ${dateType})
				)
			+
				(
				SELECT COUNT(1) FROM PP_L_BILL_CHANGE_HOUSE A
				WHERE A.DELETED_FLAG=0 AND A.STATUS = 1 AND A.FARM_ID= ${farmId}  AND A.CHANGE_TYPE = 2 AND A.CHANGE_HOUSE_DATE >= DATE_ADD(NOW(),INTERVAL -1 ${dateType})
				AND A.PIG_ID NOT IN 
					(
						SELECT B.PIG_ID FROM PP_L_BILL_DELIVERY B WHERE B.FARM_ID =  ${farmId}  AND B.DELETED_FLAG = 0
					)	
				)
			+
				(
				SELECT SUM(IF(A.CHANGE_HOUSE_DATE>B.DELIVERY_DATE,1,0)) FROM PP_L_BILL_CHANGE_HOUSE A
				LEFT JOIN PP_L_BILL_DELIVERY B
				ON A.FARM_ID = B.FARM_ID AND A.DELETED_FLAG = B.DELETED_FLAG AND A.STATUS = B.STATUS AND A.PIG_ID = B.PIG_ID
				WHERE A.DELETED_FLAG=0 AND A.STATUS = 1 AND A.FARM_ID= ${farmId} AND A.CHANGE_TYPE = 2 AND A.CHANGE_HOUSE_DATE >= DATE_ADD(NOW(),INTERVAL -1 ${dateType})
				)
			)
			/
			(
			SELECT COUNT(1) FROM PP_L_BILL_BREED A 
			WHERE A.DELETED_FLAG=0 AND A.STATUS = 1 AND A.FARM_ID= ${farmId} AND A.BREED_DATE_FIRST >= DATE_ADD(DATE_ADD(NOW(),INTERVAL -1 ${dateType}) , INTERVAL -114 DAY)
			)
			*100 DELIVERY_PROBABILITY
			]]>
	</select>
		
	<!-- 综合指标 出生重 -->
	<select id="searchPigBirthWeightByDate" resultType="map">
			<![CDATA[ 
			
				SELECT SUM(a.ALIVE_LITTER_WEIGHT)/SUM(HEALTHY_NUM) Birth_Weight
				FROM pp_l_bill_delivery a WHERE  a.DELETED_FLAG = 0 
				AND a.FARM_ID = ${farmId} 
				AND a.DELIVERY_DATE >= DATE_ADD(DATE(NOW()),INTERVAL -1 ${dateType})
			
			]]>
	</select>
		
	<!-- 综合指标 生产母猪生产天数之和-->
	<select id="searchProductPigProductionDaysByDate" resultType="map">
			<![CDATA[ 
				SELECT 
					IFNULL(SUM(IF(A.PIG_CLASS IN(9,10),TIMESTAMPDIFF(DAY,A.TOWORK_DATE,IFNULL(B.TOWORK_DATE,NOW())),0)),0) DAYS
				FROM PP_L_BILL_TOWORK A
				LEFT JOIN PP_L_BILL_TOWORK B 
					ON A.FARM_ID = B.FARM_ID AND A.DELETED_FLAG = B.DELETED_FLAG AND A.STATUS = B.STATUS AND A.ROW_ID=B.CHANGE_PIG_CLASS_ID
				WHERE A.DELETED_FLAG=0 AND A.STATUS=1 
					AND A.PIG_CLASS BETWEEN 4 AND 11 
					AND (A.PIG_CLASS <> B.PIG_CLASS OR B.PIG_CLASS IS NULL )
					AND A.FARM_ID=  ${farmId}  
					AND A.TOWORK_DATE >= DATE_ADD(DATE(NOW()),INTERVAL -1  ${dateType}) 
			]]>
	</select>
		
	<!-- 综合指标 24断奶重  产房转保育-->
	<select id="search24DayWeanPigWeightByDate" resultType="map">
			<![CDATA[ 
					SELECT AVG(TIMESTAMPDIFF(DAY,B.BIRTH_DATE,A.CHILD_DATE)) AVG_DAY,AVG(A.CHILD_WEIGHT) AVG_WEIGHT 
					FROM pp_l_bill_to_child A 
					LEFT JOIN PP_L_PIG B
					ON A.FARM_ID = B.FARM_ID AND A.DELETED_FLAG = B.DELETED_FLAG AND A.STATUS = B.STATUS AND A.PIG_ID = B.ROW_ID
					WHERE A.DELETED_FLAG = 0 AND A.STATUS = 1 AND A.CHANGE_HOUSE_TYPE = 4 
					AND A.FARM_ID = ${farmId} 
					AND A.CHILD_DATE >=  DATE_SUB(CURDATE(),INTERVAL DAYOF${dateType}(NOW())-1 DAY)
			]]>
	</select>
		
	<!-- 综合指标 7030重-->
	<select id="search7030PigWeightByDate" resultType="map">
			<![CDATA[ 
					SELECT AVG(TIMESTAMPDIFF(DAY,B.BIRTH_DATE,A.CHILD_DATE)) AVG_DAY,AVG(A.CHILD_WEIGHT) AVG_WEIGHT
					FROM pp_l_bill_to_child A 
					LEFT JOIN PP_L_PIG B
					ON A.FARM_ID = B.FARM_ID AND A.DELETED_FLAG = B.DELETED_FLAG AND A.STATUS = B.STATUS AND A.PIG_ID = B.ROW_ID
					WHERE A.DELETED_FLAG = 0 AND A.STATUS = 1 AND A.CHANGE_HOUSE_TYPE = 6
					AND A.FARM_ID = ${farmId}  
					AND A.CHILD_DATE >= DATE_SUB(CURDATE(),INTERVAL DAYOF${dateType}(NOW())-1 DAY)
			]]>
	</select>
		
	<!-- 综合指标 根据参数校正结果-->
	<select id="getWeightByDayAge" resultType="map">
			<![CDATA[ 
					SELECT _getWeightByDayAge(${farmId},'${correctionType}',${avgDay},${avgWeight}) CORRECTION_WEIGHT
			]]>
	</select>
			
	<!-- 综合指标  产房全程成活率 _________公式:100-产房仔猪死亡数量÷(产房健仔数+判断弱仔数) -->
	<select id="searchDeliverySurvivalRateByDate" resultType="map">
			<![CDATA[ 
			SELECT 
			100-(
				(
					SELECT COUNT(1) PIG_QTY 
					FROM PP_L_BILL_LEAVE A 
					LEFT JOIN PP_O_HOUSE B 
					ON A.FARM_ID = B.FARM_ID AND A.DELETED_FLAG = B.DELETED_FLAG AND A.STATUS = B.STATUS AND A.HOUSE_ID = B.ROW_ID 
					WHERE A.DELETED_FLAG=  0 AND A.STATUS = 1 AND A.FARM_ID = ${farmId} AND a.PIG_CLASS IN (12,IF((SELECT A.SETTING_VALUE FROM CD_M_SETTING A WHERE A.SETTING_CODE = 'RZBSCL' AND A.FARM_ID= ${farmId} ) = 'ON',12,13),14)
					AND A.LEAVE_DATE >=  DATE_ADD(DATE(NOW()),INTERVAL -1 ${dateType}) AND B.HOUSE_TYPE = ${houseType} AND A.LEAVE_TYPE = 3 
				)/(
					SELECT 
					SUM(IF(HEALTHY_NUM IS NULL,0,HEALTHY_NUM)) +
					IF((SELECT A.SETTING_VALUE FROM CD_M_SETTING A WHERE A.SETTING_CODE = 'RZBSCL' AND A.FARM_ID=  ${farmId} ) = 'ON',0,SUM(IF(WEAK_NUM IS NULL,0,WEAK_NUM))) HEALTHY_NUM
					FROM PP_L_BILL_DELIVERY A WHERE A.FARM_ID =  ${farmId}  AND A.DELETED_FLAG = 0 AND A.DELIVERY_DATE >= DATE_ADD(DATE(NOW()),INTERVAL -1 ${dateType})
				)*100
			) SURVIVAL_RATE
			]]>
	</select>
	
		
	<!-- 综合指标  **全程成活率 -->
	<select id="searchXXSurvivalRateByDate" resultType="map">
			<![CDATA[ 
			SELECT 
			100-
			(
				(
					SELECT COUNT(1) 
					FROM pp_l_bill_leave a 
					WHERE A.DELETED_FLAG=0 AND A.STATUS = 1 AND A.PIG_TYPE = 3 AND A.LEAVE_TYPE = 4 AND a.PIG_CLASS IN (${pigClass}) AND A.FARM_ID = ${farmId}  AND a.LEAVE_DATE >= DATE_ADD(DATE(NOW()),INTERVAL -1  ${dateType})
				)/(
				SELECT 
					SUM(IF(HEALTHY_NUM IS NULL,0,HEALTHY_NUM)) +
					IF((SELECT A.SETTING_VALUE FROM CD_M_SETTING A WHERE A.SETTING_CODE = 'RZBSCL' AND A.FARM_ID=  ${farmId}  ) = 'ON',0,SUM(IF(WEAK_NUM IS NULL,0,WEAK_NUM))) HEALTHY_NUM
					FROM PP_L_BILL_DELIVERY A WHERE A.FARM_ID =  ${farmId}  AND A.DELETED_FLAG = 0 AND A.DELIVERY_DATE >= DATE_ADD(DATE(NOW()),INTERVAL -1 ${dateType})
				)*100
			) SURVIVAL_RATE
			]]>
	</select>
		<!-- 综合指标  **全程成活率 -->
		<!-- 					
			SELECT 
			100-
			(
				(
					SELECT COUNT(1) 
					FROM pp_l_bill_leave a 
					WHERE A.DELETED_FLAG=0 AND A.STATUS = 1 AND A.PIG_TYPE = 3 AND A.LEAVE_TYPE = 4 AND a.PIG_CLASS IN (${pigClass}) AND A.FARM_ID = ${farmId}  AND a.LEAVE_DATE >= DATE_ADD(DATE(NOW()),INTERVAL -1  ${dateType})
				)/(
					SELECT 
					SUM(IF(HEALTHY_NUM IS NULL,0,HEALTHY_NUM)) +
					IF((SELECT A.SETTING_VALUE FROM CD_M_SETTING A WHERE A.SETTING_CODE = 'RZBSCL' AND A.FARM_ID=  ${farmId}  ) = 'ON',0,SUM(IF(WEAK_NUM IS NULL,0,WEAK_NUM))) HEALTHY_NUM
					FROM PP_L_BILL_DELIVERY A WHERE A.FARM_ID =  ${farmId}  AND A.DELETED_FLAG = 0 AND A.DELIVERY_DATE >= DATE_ADD(DATE(NOW()),INTERVAL -1 ${dateType})
					)*100
			) SURVIVAL_RATE 
			-->
					
	<!-- 综合指标  全场全程成活率 产房死亡仔猪+保育猪死亡+育肥猪死亡-->
	<select id="searchCompleteSurvivalRateByDate" resultType="map">
			<![CDATA[ 
			SELECT 
			100- (
				(
					(
					SELECT COUNT(1) PIG_QTY 
					FROM PP_L_BILL_LEAVE A 
					LEFT JOIN PP_O_HOUSE B 
					ON A.FARM_ID = B.FARM_ID AND A.DELETED_FLAG = B.DELETED_FLAG AND A.STATUS = B.STATUS AND A.HOUSE_ID = B.ROW_ID 
					WHERE A.DELETED_FLAG=  0 AND A.STATUS = 1 AND A.FARM_ID = ${farmId} AND a.PIG_CLASS IN (12,IF((SELECT A.SETTING_VALUE FROM CD_M_SETTING A WHERE A.SETTING_CODE = 'RZBSCL' AND A.FARM_ID= 13  ) = 'ON',12,13),14)
					AND A.LEAVE_DATE >=  DATE_ADD(DATE(NOW()),INTERVAL -1 ${dateType}) AND B.HOUSE_TYPE = ${houseType} AND A.LEAVE_TYPE = 3 
				)+(
					SELECT COUNT(1) 
					FROM pp_l_bill_leave a 
					WHERE A.DELETED_FLAG=0 AND A.STATUS = 1 AND A.PIG_TYPE = 3 AND A.LEAVE_TYPE = 4 AND a.PIG_CLASS IN (${pigClass}) AND A.FARM_ID = ${farmId}  AND a.LEAVE_DATE >= DATE_ADD(DATE(NOW()),INTERVAL -1  ${dateType})
				)
				)/(
					SELECT 
					SUM(IF(HEALTHY_NUM IS NULL,0,HEALTHY_NUM)) +
					IF((SELECT A.SETTING_VALUE FROM CD_M_SETTING A WHERE A.SETTING_CODE = 'RZBSCL' AND A.FARM_ID=  ${farmId}  ) = 'ON',0,SUM(IF(WEAK_NUM IS NULL,0,WEAK_NUM))) HEALTHY_NUM
					FROM PP_L_BILL_DELIVERY A WHERE A.FARM_ID =  ${farmId}  AND A.DELETED_FLAG = 0 AND A.DELIVERY_DATE >= DATE_ADD(DATE(NOW()),INTERVAL -1 ${dateType})
				))*100
			SURVIVAL_RATE
			]]>
	</select>
			<!-- 综合指标  全场全程成活率 -->
		<!-- 
					SELECT 
			100- (
				(
					SELECT COUNT(1) 
					FROM pp_l_bill_leave a 
					WHERE A.DELETED_FLAG=0 AND A.STATUS = 1 AND A.PIG_TYPE = 3 AND A.LEAVE_TYPE = 4  
					AND (
						A.PIG_CLASS IN (12,14,15,16) OR A.PIG_CLASS = IF((SELECT A.SETTING_VALUE FROM CD_M_SETTING A WHERE A.SETTING_CODE = 'RZBSCL' AND A.FARM_ID = 7 ) = 'ON',12,13)
					)
					AND A.FARM_ID = ${farmId}  AND a.LEAVE_DATE >= DATE_ADD(DATE(NOW()),INTERVAL -1  ${dateType})
				)/(
					SELECT 
					SUM(IF(HEALTHY_NUM IS NULL,0,HEALTHY_NUM)) +
					IF((SELECT A.SETTING_VALUE FROM CD_M_SETTING A WHERE A.SETTING_CODE = 'RZBSCL' AND A.FARM_ID=  ${farmId}  ) = 'ON',0,SUM(IF(WEAK_NUM IS NULL,0,WEAK_NUM))) HEALTHY_NUM
					FROM PP_L_BILL_DELIVERY A WHERE A.FARM_ID =  ${farmId}  AND A.DELETED_FLAG = 0 AND A.DELIVERY_DATE >= DATE_ADD(DATE(NOW()),INTERVAL -1 ${dateType}) 
				)*100
			) SURVIVAL_RATE
		 -->
		
	<!-- 综合指标   110KG出栏日龄   出售-->
	<select id="search110kgOutHouseByDate" resultType="map">
			<![CDATA[ 
			SELECT 
				S.AVG_DAY,R.AVG_WEIGHT
			FROM (
			(
				SELECT 
					SUM(A.TOTAL_WEIGHT) / SUM(A.SALE_NUM) AVG_WEIGHT
				FROM PP_L_BILL_PIG_SALE_DETAIL A
				LEFT JOIN PP_L_BILL_PIG_SALE B 
				ON A.DELETED_FLAG = B.DELETED_FLAG AND A.STATUS = B.STATUS AND A.FARM_ID = B.FARM_ID AND A.BILL_ID = B.BILL_ID
				WHERE A.DELETED_FLAG = 0 AND A.STATUS = 1 AND A.FARM_ID= ${farmId} 
				AND B.SALE_TYPE = 1 
				AND A.SALE_DATE >= DATE_ADD(DATE(NOW()),INTERVAL -1  MONTH )
			) R,(
				SELECT AVG(TIMESTAMPDIFF(DAY,A.BIRTH_DATE,C.SALE_DATE)) AVG_DAY
				FROM PP_L_PIG A 
				LEFT JOIN PP_L_BILL_LEAVE B 
				ON A.FARM_ID = B.FARM_ID AND A.DELETED_FLAG = B.DELETED_FLAG AND A.STATUS = B.STATUS AND A.ROW_ID = B.PIG_ID
				LEFT JOIN PP_L_BILL_PIG_SALE_DETAIL C 
				ON A.FARM_ID = C.FARM_ID AND A.DELETED_FLAG = C.DELETED_FLAG AND A.STATUS = C.STATUS AND B.BILL_ID = C.BILL_ID
				WHERE A.DELETED_FLAG = 0 AND A.STATUS = 1 
				AND A.FARM_ID = ${farmId}  
				AND C.SALE_DATE >= DATE_ADD(DATE(NOW()),INTERVAL -1 ${dateType} )
				) S
			)
			]]>
	</select>
		
	<!-- 综合指标 综合指标 PSY（预测）  -->
	<select id="searchPSYByDate" resultType="map">
			<![CDATA[ 
			SELECT 
				IFNULL(SUM(A.WEAN_NUM),0) SOW_SUM,
				TIMESTAMPDIFF(DAY,DATE_ADD(DATE(NOW()),INTERVAL -1 YEAR),NOW()) DAY_LENGTH
			FROM PP_L_BILL_WEAN A 
			WHERE A.DELETED_FLAG = 0 AND A.STATUS = 1 
			AND a.FARM_ID=${farmId}   
			AND a.WEAN_DATE  >= DATE_ADD(DATE(NOW()),INTERVAL -1 ${dateType})
			]]>
	</select>
		
	<!-- 综合指标   综合指标 MSY（预测）平均胎次活仔数-->
	<select id="searchMSYByDate" resultType="map">
			<![CDATA[ 
				SELECT T.BY_CHL*Y.YF_CHL BY_AND_YF_CHL
				FROM 
				(
				SELECT (COUNT(1)-SUM(IF(b.PIG_CLASS = 16,1,0)))/COUNT(1) BY_CHL FROM pp_l_bill_to_child a 
				LEFT JOIN pp_l_bill_leave b 
				ON a.DELETED_FLAG = b.DELETED_FLAG AND a.STATUS = b.STATUS AND a.FARM_ID = b.FARM_ID AND a.PIG_ID = b.PIG_ID
				WHERE a.DELETED_FLAG = 0 AND a.STATUS = 1 
					AND a.FARM_ID = ${farmId}  
					AND a.CHANGE_HOUSE_TYPE IN(5,6)
					AND a.CHILD_DATE >= DATE_ADD(NOW(),INTERVAL -1 ${dateType})
				) T
				,
				(
				SELECT (COUNT(1)-SUM(IF(b.PIG_CLASS = 15,1,0)))/COUNT(1) YF_CHL FROM pp_l_bill_to_child a 
				LEFT JOIN pp_l_bill_leave b 
				ON a.DELETED_FLAG = b.DELETED_FLAG AND a.STATUS = b.STATUS AND a.FARM_ID = b.FARM_ID AND a.PIG_ID = b.PIG_ID
				WHERE a.DELETED_FLAG = 0 AND a.STATUS = 1 
					AND a.FARM_ID = ${farmId}  
					AND a.CHANGE_HOUSE_TYPE IN(3,4)
					AND a.CHILD_DATE >= DATE_ADD(NOW(),INTERVAL -1 ${dateType})
				) Y
			]]>
	</select>
		
	<!-- 综合指标   综合指标 MSY（预测）平均胎次活仔数-->
	<select id="searchMSYByDate2" resultType="map">
			<![CDATA[ 
				SELECT t1.HEALTHY_NUM/t2.delivery_num avg_parity_child_pig FROM (
					SELECT 
					SUM(IF(HEALTHY_NUM IS NULL,0,HEALTHY_NUM)) +
					IF((SELECT A.SETTING_VALUE FROM CD_M_SETTING A WHERE A.SETTING_CODE = 'RZBSCL' AND A.FARM_ID=  ${farmId}  ) = 'ON',0,SUM(IF(WEAK_NUM IS NULL,0,WEAK_NUM))) HEALTHY_NUM
					FROM PP_L_BILL_DELIVERY A WHERE A.FARM_ID =  ${farmId}  AND A.DELETED_FLAG = 0 AND A.DELIVERY_DATE >= DATE_ADD(DATE(NOW()),INTERVAL -1 ${dateType})
				) t1,
				(
					SELECT COUNT(1) delivery_num FROM pp_l_bill_delivery a WHERE a.FARM_ID = ${farmId} AND a.DELETED_FLAG = 0 AND a.STATUS = 1 AND a.DELIVERY_DATE >= DATE_ADD(DATE(NOW()),INTERVAL -1 ${dateType})
				) t2
				
			]]>
	</select>
<!-- 	肥猪销售数量			
				SELECT SUM(a.`SALE_NUM`) sale_num,a.* 
				FROM `pp_l_bill_pig_sale_detail` a 
				WHERE a.`FARM_ID` = 17 AND a.`DELETED_FLAG` = 0 AND a.`SALE_DATE` >= DATE_ADD(DATE(NOW()),INTERVAL -1 YEAR)
				AND a.`SALE_DESCRIBE` IN (3,4,5) 
				-->
				
				
		<!-- _______________________________________________________销售部分__________________________________________________________ -->
				
		<!-- 在上个月月初到今天的时间段中取数据 + 今年的销量和出栏量 -->
		<select id="searchGroupSsalesOfRealTimeStatistics1" resultType="map">
			<![CDATA[ 
				SELECT 
				T.SALE_NUM_LAST_MONTH,
				T.SALE_NUM_LAST_WEEK,
				T.SALE_NUM_THIS_DAY,
				T.SALE_NUM_THIS_MONTH,
				(T.SALE_NUM_THIS_MONTH - T.SALE_NUM_LAST_MONTH)/T.SALE_NUM_LAST_MONTH*100 SALE_PROBABILITY,
				T.MARKETING_LAST_MONTH,
				T.MARKETING_LAST_WEEK,
				T.MARKETING_THIS_DAY,
				T.MARKETING_THIS_MONTH,
				(T.MARKETING_THIS_MONTH - T.MARKETING_LAST_MONTH)/T.MARKETING_LAST_MONTH*100 MARKETING_PROBABILITY,
				T1.SALE_NUM_THIS_YEAR,
				t1.MARKETING_THIS_YEAR,
				T1.MARKETING_TOTAL_PRICE_THIS_YEAR MARKETING_TOTAL_PRICE_THIS_YEAR
				FROM (
					SELECT 
					SUM(IF(A.SALE_DATE < DATE_ADD(CURDATE(),INTERVAL -DAY(CURDATE())+1 DAY),A.SALE_NUM,0)) SALE_NUM_LAST_MONTH,
					SUM(IF(A.SALE_DATE >= DATE_ADD(CURDATE(),INTERVAL -1 WEEK),A.SALE_NUM,0)) SALE_NUM_LAST_WEEK,
					SUM(IF(A.SALE_DATE >= CURDATE(),A.SALE_NUM,0)) SALE_NUM_THIS_DAY,
					SUM(IF(A.SALE_DATE >= DATE_ADD(CURDATE(),INTERVAL -DAY(CURDATE())+1 DAY),A.SALE_NUM,0)) SALE_NUM_THIS_MONTH,
					
					SUM(IF(A.SALE_DESCRIBE = 3 AND A.SALE_DATE < DATE_ADD(CURDATE(),INTERVAL -DAY(CURDATE())+1 DAY),A.SALE_NUM,0)) MARKETING_LAST_MONTH ,
					SUM(IF(A.SALE_DESCRIBE = 3 AND A.SALE_DATE >= DATE_ADD(CURDATE(),INTERVAL -1 WEEK),A.SALE_NUM,0)) MARKETING_LAST_WEEK,
					SUM(IF(A.SALE_DESCRIBE = 3 AND A.SALE_DATE >= CURDATE(),A.SALE_NUM,0)) MARKETING_THIS_DAY,
					SUM(IF(A.SALE_DESCRIBE = 3 AND A.SALE_DATE >= DATE_ADD(CURDATE(),INTERVAL -DAY(CURDATE())+1 DAY),A.SALE_NUM,0)) MARKETING_THIS_MONTH
					FROM PP_L_BILL_PIG_SALE_DETAIL A WHERE A.DELETED_FLAG = 0 AND A.STATUS = 1 
					AND A.SALE_DATE BETWEEN DATE_SUB(DATE_SUB(CURDATE(),INTERVAL DAY(NOW())-1 DAY),INTERVAL 1 MONTH) AND NOW()
			) T,(
			SELECT 
				SUM(IFNULL(A.SALE_NUM,0)) SALE_NUM_THIS_YEAR,
				SUM(IF(A.SALE_DESCRIBE = 3,A.SALE_NUM,0)) MARKETING_THIS_YEAR,
				SUM(IF(A.SALE_DESCRIBE = 3,A.TOTAL_PRICE,0)) + SUM(IF(A.SALE_DESCRIBE = 3,B.PAYMENT_DIFF,0)) MARKETING_TOTAL_PRICE_THIS_YEAR
			FROM PP_L_BILL_PIG_SALE_DETAIL A 
			INNER JOIN PP_L_BILL_PIG_SALE B
			ON A.FARM_ID = B.FARM_ID AND A.STATUS = B.STATUS AND A.DELETED_FLAG = B.DELETED_FLAG AND A.BILL_ID = B.BILL_ID
			WHERE A.DELETED_FLAG = 0 AND A.STATUS = 1 
			AND A.SALE_DATE BETWEEN DATE_ADD(CURDATE(),INTERVAL -DAYOFYEAR(NOW())+1 DAY) AND NOW()
			) T1

			]]>
		</select>
				
		<!-- 在上个月月初到今天的时间段中取数据 -->
		<select id="searchGroupSsalesOfRealTimeStatistics2" resultType="map">
			<![CDATA[ 
				SELECT 
					SUM(IF(A.OPEN_TIME < DATE_ADD(CURDATE(),INTERVAL -DAY(CURDATE())+1 DAY),1,0)) COMPANY_LAST_MONTH,
					SUM(IF(A.OPEN_TIME >= DATE_ADD(CURDATE(),INTERVAL -1 WEEK),1,0)) COMPANY_LAST_WEEK,
					SUM(IF(A.OPEN_TIME >= CURDATE(),1,0)) COMPANY_THIS_DAY,
					SUM(IF(A.OPEN_TIME >= DATE_ADD(CURDATE(),INTERVAL -DAY(CURDATE())+1 DAY),1,0)) COMPANY_THIS_MONTH,
					FORMAT(SUM(IF(A.OPEN_TIME >= DATE_ADD(CURDATE(),INTERVAL -DAY(CURDATE())+1 DAY),1,0)) / SUM(IF(A.OPEN_TIME < DATE_ADD(CURDATE(),INTERVAL -DAY(CURDATE())+1 DAY),1,0)),2) COMPANY_PROBABILITY,
					COUNT(1) COMPANY_YEAR
				FROM HR_M_COMPANY A 
				WHERE A.DELETED_FLAG = 0 AND A.STATUS = 1 AND A.CUSSUP_TYPE = 'C' 
				AND A.OPEN_TIME BETWEEN DATE_SUB(DATE_SUB(CURDATE(),INTERVAL DAY(NOW())-1 DAY),INTERVAL 1 MONTH) AND NOW()
			]]>
		</select>
				
		<select id="searchCompanyAddreed" resultType="map">
			<![CDATA[ 
				SELECT 
					ROW_ID rowId,
					IF(ISNULL(COMPANY_CLASS),3,COMPANY_CLASS) companyClass,
					COMPANY_NAME companyName,
					SORT_NAME sortName,
					COMPANY_ADDRESS companyAddress,
					COMPANY_CODE companyCode,
					LONGITUDE longitude,
					LATITUDE latitude 
				FROM
				  HR_M_COMPANY 
				WHERE 
				DELETED_FLAG = '0'
				AND STATUS = '1' 
				AND LONGITUDE IS NOT NULL
			]]>
		</select>
		
		<!-- 集团-猪场销售情况 -->
		<select id="searchFarmSalePig" resultType="map">
			<![CDATA[ 
				SELECT T3.COMPANY_NAME,T3.SORT_NAME,T0.FARM_ID,
					SUM(IF(T1.SALE_DESCRIBE = 3,T1.SALE_NUM,0)) SALE_NUM_FZ,
					SUM(IF(T1.SALE_DESCRIBE = 4,T1.SALE_NUM,0)) SALE_NUM_MZ,
					FORMAT(SUM(IF(T1.SALE_DESCRIBE = 3,T1.SALE_NUM,0))/SUM(T1.SALE_NUM)*100,2) SALE_PROPORTION_FZ,
					FORMAT(SUM(IF(T1.SALE_DESCRIBE = 4,T1.SALE_NUM,0))/SUM(T1.SALE_NUM)*100,2) SALE_PROPORTION_MZ,
					FORMAT(SUM(IF(T1.SALE_DESCRIBE = 3,T1.TOTAL_WEIGHT,0))/SUM(IF(T1.SALE_DESCRIBE = 3,T1.SALE_NUM,0)),2) AVG_SALE_WEIGHT_FZ,
					FORMAT(SUM(IF(T1.SALE_DESCRIBE = 4,T1.TOTAL_WEIGHT,0))/SUM(IF(T1.SALE_DESCRIBE = 4,T1.SALE_NUM,0)),2) AVG_SALE_WEIGHT_MZ,
					SUM(IF(T1.SALE_DESCRIBE = 3,IFNULL(T1.TOTAL_PRICE,0),0)) SALE_PRICE_FZ,
					SUM(IF(T1.SALE_DESCRIBE = 4,IFNULL(T1.TOTAL_PRICE,0),0)) SALE_PRICE_MZ,
					SUM(T1.SALE_NUM) SALE_NUM
				FROM PP_L_BILL_PIG_SALE T0
				LEFT JOIN PP_L_BILL_PIG_SALE_DETAIL T1
				ON T0.FARM_ID = T1.FARM_ID AND T0.STATUS = T1.STATUS AND T0.DELETED_FLAG = T1.DELETED_FLAG AND T0.BILL_ID = T1.BILL_ID
				LEFT JOIN HR_M_COMPANY T3
				ON T0.DELETED_FLAG = T3.DELETED_FLAG AND T0.STATUS = T3.STATUS AND T0.FARM_ID = T3.ROW_ID
				WHERE T0.DELETED_FLAG = 0 AND T0.STATUS = 1
				AND T0.SALE_TYPE = 1 AND T1.SALE_DESCRIBE IN (3,4)
				GROUP BY T0.FARM_ID
			]]>
		</select>
		
		<!-- 残次猪销售 -->
		<select id="searchImperfectPigSaleChange" resultType="map">
			<foreach collection="list" item="item" index="index" separator="UNION ALL">
				<![CDATA[ 
					SELECT 
						'${item.startDate}' START_DATE, 
						IFNULL(SUM(IF(B.HOUSE_TYPE = 8, 1, 0)),0) BY_QTY,
						IFNULL(SUM(IF(B.HOUSE_TYPE = 9, 1, 0)),0) YF_QTY 
					FROM PP_L_BILL_PIG_SALE_DETAIL A 
					LEFT JOIN PP_O_HOUSE B
					ON A.FARM_ID = B.FARM_ID AND A.DELETED_FLAG = B.DELETED_FLAG AND A.STATUS = B.STATUS AND A.HOUSE_ID = B.ROW_ID 
					WHERE A.SALE_DESCRIBE = 5 
					AND A.SALE_DATE BETWEEN '${item.startDate}' AND '${item.endDate}'
				]]>
			</foreach>
		</select>
		
		<!-- 客户分析 -->
		<select id="searchCustomerAnalysis" resultType="map">
				<![CDATA[ 
						SELECT * FROM (
							SELECT IFNULL(T4.CODE_NAME , '不详') PROVINCE,
								T1.COMPANY_NAME,
								SUM(T3.SALE_NUM) SALE_NUM,
								SUM(IFNULL(T3.TOTAL_WEIGHT,0)) TOTAL_WEIGHT,
								FORMAT(SUM(IFNULL(T3.TOTAL_WEIGHT,0))/SUM(T3.SALE_NUM),2) AVG_WEIGHT ,
								SUM(IFNULL(T3.TOTAL_PRICE,0)) TOTAL_PRICE,
								0 SALE_INCOME,0 RECEIVABLES_INTERVAL_TIME,
								SUM(IFNULL(T3.TOTAL_PRICE,0)) RECEIVABLES_INTERVAL,
								FORMAT(SUM(IFNULL(T3.TOTAL_PRICE,0))/IF(SUM(IFNULL(T3.TOTAL_PRICE,0))=0,1,SUM(IFNULL(T3.TOTAL_PRICE,0)))*100,2) RECEIVABLES_INTERVAL_PROPORTION,
								0 PRE_PAY
							FROM HR_M_COMPANY T1
							INNER JOIN PP_L_BILL_PIG_SALE T2
							ON t1.DELETED_FLAG = t2.DELETED_FLAG AND t1.STATUS = t2.STATUS AND t1.ROW_ID = t2.CUSTOMER_ID
							INNER JOIN PP_L_BILL_PIG_SALE_DETAIL T3
							ON T2.FARM_ID = T3.FARM_ID AND T2.DELETED_FLAG = T3.DELETED_FLAG AND T2.STATUS = T3.STATUS AND T2.BILL_ID = T3.BILL_ID
							INNER JOIN cd_l_code_list T4 
							ON t1.DELETED_FLAG = t4.DELETED_FLAG AND t1.STATUS = t4.STATUS AND t1.PROVINCE = t4.CODE_VALUE
							WHERE T1.DELETED_FLAG = 0 AND T1.STATUS = 1
							GROUP BY T1.PROVINCE,T1.ROW_ID
						) T ORDER BY T.RECEIVABLES_INTERVAL DESC
				]]>
		</select>
				
</mapper>